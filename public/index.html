<html lang="es" data-bs-theme="dark">

<head>
  <meta charset="utf-8">
  <base href="/">

  <!-- CACHE CONTROL: Evita que el navegador cachee recursos locales -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <meta name="theme-color" content="#1B396A">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="assets/icons/icon-192x192.png">
  <link rel="icon" type="image/x-icon" href="images/sia-logo.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SIA | Sistema de Integración Académico</title>

  <!-- CACHE BUSTER: Sistema automático de versionado -->
  <script>
    // Genera timestamp único para evitar cache del navegador
    window.SIA_VERSION = Date.now();

    // Función helper para agregar versión automáticamente
    window.loadScript = function (src) {
      const script = document.createElement('script');
      script.src = src.includes('?') ? src : `${src}?v=${window.SIA_VERSION}`;
      document.currentScript.parentNode.insertBefore(script, document.currentScript.nextSibling);
    };

    // FORZAR DARK MODE PERMANENTE
    // Limpiar cualquier preferencia de tema anterior
    localStorage.removeItem('sia-theme');
    localStorage.removeItem('theme');
    // Forzar dark mode siempre
    document.documentElement.setAttribute('data-bs-theme', 'dark');
  </script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Librerías para Reportes (PDF y Excel) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style type="text/css" id="operaUserStyle"></style>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Tipografías Oficiales TecNM -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400&family=Source+Serif+4:opsz,wght@8..60,700;8..60,800;8..60,900&display=swap"
    rel="stylesheet">

  <!-- CSS con cache-busting automático -->
  <script>
    document.write(`<link rel="stylesheet" href="/styles.css?v=${window.SIA_VERSION}">`);
  </script>

  <!-- UTILIDADES GLOBALES (Cargar antes que app.js) -->
  <script>
    document.write(`<script src="utils/time-utils.js?v=${window.SIA_VERSION}"><\/script>`);
    document.write(`<script src="utils/export-utils.js?v=${window.SIA_VERSION}"><\/script>`);

    // Servicios y Módulos
    document.write(`<script src="services/encuestas-service.js?v=${window.SIA_VERSION}"><\/script>`);
    document.write(`<script src="services/encuestas-servicio-service.js?v=${window.SIA_VERSION}"><\/script>`);

    document.write(`<script src="services/reportes-service.js?v=${window.SIA_VERSION}"><\/script>`);
    document.write(`<script src="services/avisos-service.js?v=${window.SIA_VERSION}"><\/script>`);
    document.write(`<script src="modules/reportes.js?v=${window.SIA_VERSION}"><\/script>`);
    document.write(`<script src="modules/encuestas.js?v=${window.SIA_VERSION}"><\/script>`);
  </script>

  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script type="text/javascript">
    (function () {
      emailjs.init("I0P7oEMcm9MD-EtCY");
    })();
  </script>
  <style type="text/css"></style>
</head>

<body>
  <div id="kiosk-overlay"
    class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark text-white d-flex flex-column justify-content-center align-items-center text-center"
    style="z-index: 99999;">
    <div class="mb-4">
      <img src="/images/logo-sia.png" width="80" class="mb-3 opacity-75">
      <h1 class="display-4 fw-bold">Terminal Bloqueada</h1>
      <p class="lead text-white-50" id="kiosk-id-label">ID: --</p>
    </div>
    <div class="p-4 bg-white bg-opacity-10 rounded-4 backdrop-blur border border-white border-opacity-10"
      style="max-width: 400px;">
      <i class="bi bi-pc-display-horizontal fs-1 mb-3 text-warning"></i>
      <p class="mb-0">Esta computadora está gestionada por SIA.</p>
      <p class="small text-white-50">Solicita su desbloqueo en el mostrador.</p>
    </div>
  </div>
  <div id="app-loader"
    class="d-flex flex-column justify-content-center align-items-center position-fixed top-0 start-0 w-100 h-100 bg-surface-muted"
    style="z-index: 9999;">
    <div class="logo-wave">
      <img src="/images/cubo1.png" alt="Cubo 1" class="cube cube-1">
      <img src="/images/cubo2.png" alt="Cubo 2" class="cube cube-2">
      <img src="/images/cubo3.png" alt="Cubo 3" class="cube cube-3">

    </div>
    <span class="loader-text">SIA</span>
  </div>


  <sia-landing-view id="landing-view" class="d-none"></sia-landing-view>
  <div id="landing-view-legacy-placeholder"></div>

  <!-- ============================================== -->
  <!-- NUEVO WIZARD DE REGISTRO & SELECCIÓN DE ROL    -->
  <!-- ============================================== -->
  <sia-register-wizard id="view-register-wizard" class="d-none"></sia-register-wizard>

  <!-- ============================================== -->
  <!-- VISTA: SELECCIÓN DE DEPARTAMENTO (STAFF)       -->
  <!-- ============================================== -->
  <div id="reg-view-dept-selector"
    class="d-none min-vh-100 bg-dark d-flex align-items-center justify-content-center position-fixed top-0 start-0 w-100"
    style="z-index: 2000;">
    <div class="container text-center text-white">
      <div class="mb-5">
        <p class="fw-bold display-5 mb-2">Selecciona tu Área</p>
        <p class="lead opacity-75">Configuración de acceso administrativo simplificado</p>
      </div>

      <button onclick="SIA_Register.logout()"
        class="btn btn-sm btn-outline-light position-absolute top-0 end-0 m-4 rounded-pill">
        <i class="bi bi-box-arrow-right"></i> Salir
      </button>

      <!-- GRID PRINCIPAL -->
      <div id="dept-options-main" class="row g-4 justify-content-center fade-in">
        <div class="col-md-3 col-sm-6">
          <div onclick="SIA_Register.selectDept('biblioteca')"
            class="card bg-white bg-opacity-10 border border-white border-opacity-10 hover-scale cursor-pointer p-4 h-100 rounded-4">
            <i class="bi bi-book-half display-4 mb-3 text-warning"></i>
            <h5 class="fw-bold">Biblioteca</h5>
            <p class="small opacity-50 mb-0">Gestión de acervo, préstamos y devoluciones.</p>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div onclick="SIA_Register.selectDept('medico')"
            class="card bg-white bg-opacity-10 border border-white border-opacity-10 hover-scale cursor-pointer p-4 h-100 rounded-4">
            <i class="bi bi-heart-pulse-fill display-4 mb-3 text-danger"></i>
            <h5 class="fw-bold">Servicios Médicos</h5>
            <p class="small opacity-50 mb-0">Consultas, historial clínico y urgencias.</p>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div onclick="SIA_Register.selectDept('aula')"
            class="card bg-white bg-opacity-10 border border-white border-opacity-10 hover-scale cursor-pointer p-4 h-100 rounded-4">
            <i class="bi bi-mortarboard-fill display-4 mb-3 text-primary"></i>
            <h5 class="fw-bold">Aula Virtual</h5>
            <p class="small opacity-50 mb-0">Administración de cursos y certificaciones.</p>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div onclick="SIA_Register.selectDept('foro')"
            class="card bg-white bg-opacity-10 border border-white border-opacity-10 hover-scale cursor-pointer p-4 h-100 rounded-4">
            <i class="bi bi-people-fill display-4 mb-3 text-info"></i>
            <h5 class="fw-bold">Foro / Eventos</h5>
            <p class="small opacity-50 mb-0">Control de asistencia y agenda cultural.</p>
          </div>
        </div>
      </div>

      <!-- SUB-OPCIONES MÉDICO -->
      <div id="dept-options-medico" class="row g-4 justify-content-center d-none fade-in">
        <div class="col-12 mb-3">
          <button onclick="SIA_Register.backToDeptMain()" class="btn btn-link text-white text-decoration-none">
            <i class="bi bi-arrow-left"></i> Volver
          </button>
          <p class="fw-bold">Especialidad Médica</p>
        </div>
        <div class="col-md-4">
          <div onclick="SIA_Register.submitStaffRegistration('medico', 'medico')"
            class="card bg-danger bg-opacity-75  hover-scale cursor-pointer p-4 rounded-4 border-0">
            <i class="bi bi-hospital display-1 mb-2"></i>
            <h3>Médico General</h3>
          </div>
        </div>
        <div class="col-md-4">
          <div onclick="SIA_Register.submitStaffRegistration('medico', 'psicologo')"
            class="card bg-primary bg-opacity-75 hover-scale cursor-pointer p-4 rounded-4 border-0">
            <i class="bi bi-emoji-smile display-1 mb-2"></i>
            <h3>Psicología</h3>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- MODAL CHECK STAFF -->
  <div class="modal fade" id="modal-register-staff-check" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 border-0 shadow-lg">
        <div class="modal-body p-5 text-center">
          <div class="mb-4 text-primary">
            <i class="bi bi-building-check display-1"></i>
          </div>
          <h3 class="fw-bold mb-3">Perfil Institucional Detectado</h3>
          <p class="text-muted mb-4">
            Tu correo parece pertenecer a un departamento oficial (Biblioteca, Médico, etc).<br>
            <strong>¿Deseas configurar esta cuenta como ADMINISTRADOR DE ÁREA?</strong>
          </p>
          <div class="d-grid gap-3">
            <button id="btn-staff-yes" class="btn btn-primary btn-lg rounded-pill fw-bold shadow">
              Sí, soy encargado de área
            </button>
            <button id="btn-staff-no" class="btn btn-outline-secondary rounded-pill">
              No, quiero entrar como usuario normal
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="app-shell" class="">
    <!-- Navbar (Web Component) - Desktop Only via CSS classes -->
    <sia-navbar class="d-none d-md-block"></sia-navbar>

    <!-- BOTTOM NAV (MOBILE ONLY) -->
    <nav class="bottom-nav d-md-none fade-up-entry delay-3">
      <!-- 1. Inicio -->
      <a href="javascript:void(0)" class="nav-item active" id="nav-mobile-home"
        onclick="window.SIA.navigate('view-dashboard'); updateBottomNav(this);">
        <i class="bi bi-house-door-fill"></i>
        <span>Inicio</span>
      </a>

      <!-- 2. Módulos (Drawer) -->
      <a href="javascript:void(0)" class="nav-item" id="nav-mobile-modules"
        onclick="window.SIA.toggleModulesDrawer(); updateBottomNav(this);">
        <i class="bi bi-grid-fill"></i>
        <span>Módulos</span>
      </a>

      <!-- 3. ACCIONES (CENTRAL FAB - Speed Dial) -->
      <div class="nav-item-fab">
        <button class="btn btn-primary shadow rounded-circle" id="btn-speed-dial"
          onclick="window.SIA.toggleSpeedDial()">
          <i class="bi bi-plus-lg"></i>
        </button>
      </div>

      <!-- 4. Avisos (Notificaciones) -->
      <a href="javascript:void(0)" class="nav-item" id="nav-mobile-notifications"
        onclick="window.SIA.toggleNotificationsView(); updateBottomNav(this);">
        <i class="bi bi-bell-fill"></i>
        <span>Avisos</span>
        <span class="nav-badge d-none" id="mobile-notif-badge">0</span>
      </a>

      <!-- 5. Yo (Perfil) -->
      <a href="javascript:void(0)" class="nav-item" id="nav-mobile-profile"
        onclick="window.SIA.navigate('view-profile'); updateBottomNav(this);">
        <i class="bi bi-person-circle"></i>
        <span>Yo</span>
      </a>
    </nav>


    <!-- MOVED GLOBAL MODALS (ACCESSIBLE EVERYWHERE) -->
    <div class="modal fade" id="modalDigitalID" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-transparent border-0 shadow-none">
          <div class="modal-body d-flex justify-content-center">

            <div class="digital-id-card p-4 text-start position-relative rounded-4 shadow-lg">

              <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3"
                data-bs-dismiss="modal"></button>

              <div class="d-flex justify-content-between align-items-center mb-2">
                <img src="/images/logo-sia.png" width="30">
                <div class="text-white-50 font-monospace small" id="prof-id-matricula">-------</div>
              </div>

              <!-- Avatar & QR Container -->
              <div class="text-center my-3">
                <!-- Avatar Circle -->
                <div
                  class="rounded-circle border border-2 border-white shadow-sm d-inline-flex align-items-center justify-content-center overflow-hidden mb-3 bg-white"
                  style="width: 80px; height: 80px;">
                  <span id="prof-id-avatar-init" class="fs-2 fw-bold text-primary">U</span>
                  <img id="prof-id-avatar-img" src="" class="w-100 h-100 object-fit-cover d-none">
                </div>

                <!-- QR Code -->
                <div class="bg-white p-2 d-inline-block rounded-3 shadow-sm mx-auto d-block"
                  style="width: 140px; height: 140px;">
                  <img id="prof-qr-full" src="" class="img-fluid w-100 h-100">
                </div>
              </div>

              <div class="text-center">
                <h5 class="fw-bold mb-0 text-white" id="prof-id-name">Estudiante</h5>
                <span class="badge bg-success mt-1">VIGENTE 2025</span>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalConsultaSuccess" tabindex="-1" data-bs-backdrop="static">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow-lg">
          <div class="modal-body p-5 text-center">
            <div class="mb-4 text-success animate-bounce">
              <i class="bi bi-check-circle-fill display-1"></i>
            </div>
            <h2 class="fw-bold mb-3">Consulta Guardada</h2>
            <p class="text-muted mb-4">La consulta ha sido registrada exitosamente en el expediente del paciente.</p>

            <div class="d-grid gap-3">
              <button class="btn btn-primary rounded-pill py-2 fw-bold shadow-sm" onclick="Medi.printReceta()">
                <i class="bi bi-printer-fill me-2"></i> Imprimir Receta
              </button>
              <button class="btn btn-outline-primary rounded-pill py-2 fw-bold" onclick="Medi.sendToPatient()">
                <i class="bi bi-send-fill me-2"></i> Enviar Digital
              </button>
              <button class="btn btn-light rounded-pill py-2" data-bs-dismiss="modal">
                Cerrar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================== -->
    <!-- MODAL: AVISO FULLSCREEN (Estudiantes)          -->
    <!-- ============================================== -->
    <div class="modal fade" id="modalAvisoFullscreen" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-xl modal-dialog-centered modal-aviso-glass">
        <div class="modal-content border-0 position-relative overflow-hidden" style="background: transparent;">
          <!-- Progress Bars (stories-style) -->
          <div class="position-absolute top-0 start-0 w-100 d-flex gap-1 p-2" style="z-index:15;"
            id="aviso-progress-bars"></div>
          <!-- Close Button -->
          <button class="btn-close btn-close-white position-absolute top-0 end-0 m-3"
            style="z-index:20; filter: drop-shadow(0 0 4px rgba(0,0,0,0.8));" id="aviso-fullscreen-close"></button>
          <!-- Content Area -->
          <div id="aviso-fullscreen-content"
            class="h-100 w-100 d-flex align-items-center justify-content-center overflow-hidden">
            <!-- Inyectado dinámicamente -->
          </div>
          <!-- Navigation Arrows -->
          <button class="btn position-absolute start-0 top-50 translate-middle-y text-white fs-2 d-none"
            id="aviso-nav-prev" style="z-index:15; background:none; border:none; opacity:0.7;">
            <i class="bi bi-chevron-left"></i>
          </button>
          <button class="btn position-absolute end-0 top-50 translate-middle-y text-white fs-2 d-none"
            id="aviso-nav-next" style="z-index:15; background:none; border:none; opacity:0.7;">
            <i class="bi bi-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- ============================================== -->
    <!-- MODAL: AVISOS ADMIN PANEL (Difusión)           -->
    <!-- ============================================== -->
    <div class="modal fade" id="modalAvisosAdmin" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content border-0 rounded-4 shadow-lg overflow-hidden">
          <div class="modal-header border-0 bg-success bg-gradient text-white py-3 px-4">
            <div>
              <h5 class="modal-title fw-bold mb-0"><i class="bi bi-megaphone-fill me-2"></i>Avisos Institucionales</h5>
              <small class="opacity-75">Gestiona los anuncios para toda la comunidad</small>
            </div>
            <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body p-4">

            <!-- Pestaña: Crear / Lista -->
            <ul class="nav nav-pills nav-fill gap-2 mb-4" id="avisos-admin-tabs">
              <li class="nav-item">
                <button class="nav-link active rounded-pill fw-bold" data-bs-toggle="pill"
                  data-bs-target="#avisos-tab-list">
                  <i class="bi bi-list-ul me-1"></i>Mis Avisos
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link rounded-pill fw-bold" data-bs-toggle="pill" data-bs-target="#avisos-tab-create">
                  <i class="bi bi-plus-circle me-1"></i>Crear Aviso
                </button>
              </li>
            </ul>

            <div class="tab-content">
              <!-- TAB: LISTA -->
              <div class="tab-pane fade show active" id="avisos-tab-list">
                <div id="avisos-admin-list" class="row g-3">
                  <div class="text-center text-muted py-5">
                    <i class="bi bi-megaphone fs-1 opacity-25"></i>
                    <p class="mt-2">Cargando avisos...</p>
                  </div>
                </div>
              </div>

              <!-- TAB: CREAR -->
              <div class="tab-pane fade" id="avisos-tab-create">
                <form id="form-create-aviso" class="row g-3">
                  <!-- Tipo de aviso -->
                  <div class="col-md-6">
                    <label class="form-label small fw-bold">Tipo de Aviso</label>
                    <select id="aviso-type" class="form-select rounded-3" required>
                      <option value="image">🖼️ Solo Imagen (Flyer/Poster)</option>
                      <option value="text">📝 Solo Texto</option>
                      <option value="mixed">🔀 Imagen + Texto</option>
                    </select>
                  </div>

                  <!-- Prioridad -->
                  <div class="col-md-6">
                    <label class="form-label small fw-bold">Prioridad</label>
                    <select id="aviso-priority" class="form-select rounded-3">
                      <option value="normal">Normal</option>
                      <option value="urgent">🔴 Urgente</option>
                    </select>
                  </div>

                  <!-- Título -->
                  <div class="col-12">
                    <label class="form-label small fw-bold">Título del Aviso</label>
                    <input type="text" id="aviso-title" class="form-control rounded-3"
                      placeholder="Ej: Proceso de Admisión 2026" required>
                  </div>

                  <!-- Imagen (URL o Archivo) -->
                  <div class="col-12" id="aviso-image-field">
                    <label class="form-label small fw-bold">Imagen del Aviso</label>
                    <div class="input-group mb-2">
                      <input type="file" id="aviso-imageFile" class="form-control rounded-3" accept="image/*">
                    </div>
                    <div class="text-center small text-muted mb-2">- O -</div>
                    <input type="url" id="aviso-imageUrl" class="form-control rounded-3"
                      placeholder="https://ejemplo.com/flyer.jpg">
                    <div class="form-text">Sube una imagen o pega una URL directa.</div>

                    <!-- Preview -->
                    <div id="aviso-image-preview" class="mt-2 d-none text-center bg-light rounded-3 p-2 relative">
                      <img src="" class="rounded-3 shadow-sm"
                        style="max-height:200px; max-width:100%; object-fit:contain;">
                      <button type="button"
                        class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2 rounded-circle"
                        onclick="document.getElementById('aviso-imageFile').value=''; document.getElementById('aviso-imageUrl').value=''; this.parentElement.classList.add('d-none');">
                        <i class="bi bi-x"></i>
                      </button>
                    </div>
                  </div>

                  <!-- Cuerpo de texto -->
                  <div class="col-12" id="aviso-body-field">
                    <label class="form-label small fw-bold">Contenido del Aviso</label>
                    <textarea id="aviso-body" class="form-control rounded-3" rows="4"
                      placeholder="Escribe el mensaje del aviso..."></textarea>
                  </div>

                  <!-- Configuración de Tiempos -->
                  <div class="col-md-6">
                    <label class="form-label small fw-bold">Duración en Pantalla (seg)</label>
                    <input type="number" id="aviso-displayDuration" class="form-control rounded-3" value="8" min="3"
                      max="60">
                    <div class="form-text">Tiempo que dura el slide antes de cambiar.</div>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small fw-bold">Vigencia del Aviso</label>
                    <div class="d-flex flex-wrap gap-2" id="aviso-validity-presets">
                      <input type="radio" class="btn-check" name="validity" id="val-24h" value="24h" autocomplete="off">
                      <label class="btn btn-outline-secondary btn-sm rounded-pill" for="val-24h">24 Horas</label>

                      <input type="radio" class="btn-check" name="validity" id="val-3d" value="3d" autocomplete="off"
                        checked>
                      <label class="btn btn-outline-secondary btn-sm rounded-pill" for="val-3d">3 Días</label>

                      <input type="radio" class="btn-check" name="validity" id="val-1w" value="1w" autocomplete="off">
                      <label class="btn btn-outline-secondary btn-sm rounded-pill" for="val-1w">1 Semana</label>

                      <input type="radio" class="btn-check" name="validity" id="val-custom" value="custom"
                        autocomplete="off">
                      <label class="btn btn-outline-secondary btn-sm rounded-pill"
                        for="val-custom">Personalizado</label>
                    </div>
                  </div>

                  <!-- Fechas Personalizadas (Oculto por defecto) -->
                  <div class="col-12 d-none animate-fade-in" id="aviso-custom-dates">
                    <div class="row g-2">
                      <div class="col-6">
                        <label class="form-label small fw-bold">Inicio</label>
                        <input type="datetime-local" id="aviso-startDate" class="form-control rounded-3">
                      </div>
                      <div class="col-6">
                        <label class="form-label small fw-bold">Fin</label>
                        <input type="datetime-local" id="aviso-endDate" class="form-control rounded-3">
                      </div>
                    </div>
                  </div>

                  <!-- Botones de Acción -->
                  <div class="col-12 d-flex gap-2">
                    <button type="button" id="btn-cancel-edit"
                      class="btn btn-light rounded-pill px-4 d-none">Cancelar</button>
                    <button type="submit" id="btn-submit-aviso"
                      class="btn btn-success rounded-pill fw-bold px-4 flex-grow-1 shadow-sm">
                      <i class="bi bi-megaphone-fill me-2"></i>Publicar Aviso
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <section id="global-avisos-wrap" class="bg-transparent mb-3 d-none">
      <div class="container">
        <div class="alert alert-light border-0 shadow-sm rounded-4 d-flex align-items-center p-3 mb-0 gap-3"
          role="alert">
          <div class="bg-warning-subtle text-warning rounded-circle p-2 d-flex"><i class="bi bi-broadcast"></i></div>
          <div class="flex-grow-1 small text-muted" id="global-avisos-container">No hay avisos activos.</div>
          <button class="btn btn-sm btn-light rounded-pill border" id="btn-global-avisos-modal">Ver todo</button>
        </div>
      </div>
    </section>

    <!-- VIEWS CONTAINER -->
    <!-- ============================================== -->
    <!-- DASHBOARD V3 (MOBILE-FIRST)                -->
    <!-- ============================================== -->

    <div id="view-dashboard" class="app-view container py-4 mb-5">
      <!-- HEADER: Saludo & Perfil -->
      <div class="d-flex justify-content-between align-items-center mb-4 pt-2 fade-up-entry">
        <div>
          <p class="text-secondary small mb-0 fw-medium">Hola de nuevo,</p>
          <h2 class="fw-bold text-dark mb-0" id="dash-user-name">Estudiante</h2>
        </div>
        <div class="position-relative" onclick="window.SIA.navigate('view-profile')">
          <div class="dashboard-avatar shadow-sm">
            <span id="dash-avatar-initials">U</span>
            <img id="dash-avatar-img" src="" class="d-none">
          </div>
          <span
            class="position-absolute top-0 start-100 translate-middle p-1 bg-success border border-light rounded-circle">
            <span class="visually-hidden">Online</span>
          </span>
        </div>
      </div>

      <!-- SECTION: AVISOS (STORIES) -->
      <section class="mb-4 fade-up-entry delay-1">
        <div class="d-flex justify-content-between align-items-center mb-3 px-1">
          <h6 class="fw-bold text-secondary text-uppercase small mb-0 ls-1">Novedades</h6>
          <span class="badge bg-primary-subtle text-primary rounded-pill px-3 py-1 small"
            onclick="openGlobalAvisosModal()">Ver todo</span>
        </div>

        <!-- Stories Scroll Container -->
        <div class="stories-container d-flex gap-3 overflow-auto pb-2" id="dashboard-stories-wrapper">
          <!-- Stories generadas dinámicamente por renderDashboardStories() -->
        </div>
      </section>

      <!-- SECTION: SMART CARDS (MODULES) -->
      <section class="mb-5 fade-up-entry delay-2">
        <h6 class="fw-bold text-secondary text-uppercase small mb-3 px-1 ls-1">Tus Módulos</h6>

        <div class="row g-3">

          <!-- CARD: LACTARIO (Dynamic Visibility) -->
          <div class="col-6 col-md-4 d-none animate-fade-in" id="smart-card-lactario-wrapper">
            <div class="smart-card h-100 p-3 shadow-sm rounded-4 position-relative overflow-hidden"
              onclick="window.SIA.navigate('view-lactario')">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="icon-box-sm rounded-3">
                  <img src="images/lactario.png" alt="Lactario" style="width: 52px; height: 52px; object-fit: contain;">
                </div>
                <i class="bi bi-arrow-right-short text-muted opacity-50"></i>
              </div>
              <h6 class="fw-bold mb-1">Sala de Lactancia</h6>
              <p class="extra-small text-muted mb-0">Reservar sala</p>
            </div>
          </div>

          <!-- CARD: MEDI -->
          <div class="col-6 col-md-4">
            <div class="smart-card h-100 p-3 shadow-sm rounded-4 position-relative overflow-hidden"
              onclick="window.SIA.navigate('view-medi')">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="icon-box-sm rounded-3">
                  <img src="images/medi.png" alt="Medi" style="width: 52px; height: 52px; object-fit: contain;">
                </div>
                <i class="bi bi-arrow-right-short text-muted opacity-50"></i>
              </div>
              <h6 class="fw-bold mb-1">Servicios Médicos</h6>
              <p class="extra-small text-muted mb-0" id="smart-card-medi-status">Citas médicas y atención</p>
              <!-- Indicator -->
              <div class="status-dot bg-secondary d-none" id="smart-dot-medi"></div>
            </div>
          </div>

          <!-- CARD: BIBLIO -->
          <div class="col-6 col-md-4">
            <div class="smart-card h-100 p-3 shadow-sm rounded-4 position-relative overflow-hidden"
              onclick="window.SIA.navigate('view-biblio')">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="icon-box-sm rounded-3">
                  <img src="images/biblio.png" alt="Biblio" style="width: 52px; height: 52px; object-fit: contain;">
                </div>
                <i class="bi bi-arrow-right-short text-muted opacity-50"></i>
              </div>
              <h6 class="fw-bold mb-1">Biblioteca</h6>
              <p class="extra-small text-muted mb-0" id="smart-card-biblio-status">Visita y llevate un libro a casa</p>
            </div>
          </div>

          <!-- CARD: FORO -->
          <div class="col-6 col-md-4">
            <div class="smart-card h-100 p-3 shadow-sm rounded-4 position-relative overflow-hidden"
              onclick="window.SIA.navigate('view-foro')">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="icon-box-sm rounded-3">
                  <img src="images/foro.png" alt="Foro" style="width: 52px; height: 52px; object-fit: contain;">
                </div>
                <i class="bi bi-arrow-right-short text-muted opacity-50"></i>
              </div>
              <h6 class="fw-bold mb-1">Eventos</h6>
              <p class="extra-small text-muted mb-0">Conferencias y más</p>
            </div>
          </div>

          <!-- CARD: AULA -->
          <div class="col-6 col-md-4">
            <div class="smart-card h-100 p-3 shadow-sm rounded-4 position-relative overflow-hidden"
              onclick="window.SIA.navigate('view-aula')">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="icon-box-sm rounded-3">
                  <img src="images/aula.png" alt="Aula" style="width: 52px; height: 52px; object-fit: contain;">
                </div>
                <i class="bi bi-arrow-right-short text-muted opacity-50"></i>
              </div>
              <h6 class="fw-bold mb-1">Aula Virtual</h6>
              <p class="extra-small text-muted mb-0" id="smart-card-aula-status">Consigue certificaciones en distintos
                cursos</p>
            </div>
          </div>
          <!-- CARD: QUEJAS -->
          <div class="col-6 col-md-4">
            <div class="smart-card h-100 p-3 shadow-sm rounded-4 position-relative overflow-hidden"
              onclick="window.SIA.navigate('view-quejas')">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="icon-box-sm rounded-3 d-flex align-items-center justify-content-center">
                  <img src="images/quejas.png" alt="Quejas" style="width: 62px; height: 62px; object-fit: contain;">
                </div>
                <i class="bi bi-arrow-right-short text-muted opacity-50"></i>
              </div>
              <h6 class="fw-bold mb-1">Quejas y Sugerencias</h6>
              <p class="extra-small text-muted mb-0">Buzón de Calidad</p>
            </div>
          </div>
          <!-- CARD: ENCUESTAS -->
          <div class="col-6 col-md-4">
            <div class="smart-card h-100 p-3 shadow-sm rounded-4 position-relative overflow-hidden"
              onclick="window.SIA.navigate('view-encuestas')">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="icon-box-sm rounded-3 d-flex align-items-center justify-content-center">
                  <img src="images/encuestas.png" alt="Encuestas"
                    style="width: 52px; height: 52px; object-fit: contain;">
                </div>
                <i class="bi bi-arrow-right-short text-muted opacity-50"></i>
              </div>
              <h6 class="fw-bold mb-1">Encuestas</h6>
              <p class="extra-small text-muted mb-0" id="smart-card-encuestas-status">Tu opinión importa</p>
            </div>
          </div>
        </div>
      </section>

      <!-- SECTION: QUICK ACTIONS (AGENDA / PROGRESS) REPLACEMENT -->
      <section class="mb-5 fade-up-entry delay-3">
        <div class="smart-banner p-4 rounded-4 shadow-sm text-white position-relative overflow-hidden"
          style="background: linear-gradient(135deg, #0A2540 0%, #0d3a63 100%);">
          <!-- Decorative Circle -->
          <div class="position-absolute top-0 end-0 translate-middle p-5 bg-white opacity-10 rounded-circle"
            style="margin-right: -20px; margin-top: -20px;"></div>

          <div class="position-relative z-1">
            <h5 class="fw-bold filter-white mb-1">¿Necesitas ayuda?</h5>
            <p class="small opacity-75 mb-3" style="max-width: 80%;">Reporta problemas, inicia trámites o contacta
              soporte.</p>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-light text-primary fw-bold rounded-pill px-3 shadow-sm"
                onclick="window.SIA.navigate('view-medi')">
                <i class="bi bi-chat-text-fill me-1"></i> Soporte
              </button>
              <button class="btn btn-sm btn-outline-light fw-bold rounded-pill px-3"
                onclick="window.open('mailto:soporte@loscabos.tecnm.mx')">
                Quejas
              </button>
            </div>
          </div>
        </div>
      </section>
    </div>
    <div id="view-lactario" class="app-view d-none container py-4 mb-5"> <!-- Lactario Module populated by JS --> </div>
    <div id="view-quejas" class="app-view d-none container py-4 mb-5"> <!-- Quejas Module populated by JS --> </div>
    <div id="view-biblio" class="app-view d-none container py-4 mb-5"> <!-- Biblio Module populated by JS --> </div>
    <div id="view-medi" class="app-view d-none container py-4 mb-5"> <!-- Medi Module populated by JS --> </div>
    <div id="view-aula" class="app-view d-none container py-4 mb-5"> <!-- Aula Module populated by JS --> </div>
    <div id="view-foro" class="app-view d-none container py-4 mb-5"> <!-- Foro Module populated by JS --> </div>
    <div id="view-profile" class="app-view d-none container py-4 mb-5"> <!-- Profile Module populated by JS --> </div>
    <div id="view-reportes" class="app-view d-none container py-4 mb-5"> <!-- Reportes Module populated by JS --> </div>
    <div id="view-encuestas" class="app-view d-none container py-4 mb-5"> <!-- Encuestas Module populated by JS -->
    </div>
    <div id="view-encuesta-publica" class="app-view d-none container py-4 mb-5"> <!-- Public Survey View (no auth) -->
    </div>

    <!-- ============================================== -->
    <!-- DASHBOARD DEPARTAMENTAL (ADMINS)           -->
    <!-- ============================================== -->
    <div id="view-department-dashboard" class="app-view d-none container py-5">
      <div class="row justify-content-center">
        <div class="col-lg-10">

          <!-- Header Departamental -->
          <div class="d-flex align-items-center justify-content-between mb-5 fade-up-entry">
            <div>
              <span class="badge bg-primary-subtle text-primary mb-2 px-3 py-2 rounded-pill fw-bold ls-1">PANEL
                ADMINISTRATIVO</span>
              <h1 class="display-5 fw-bold text-dark mb-1" id="dept-dash-title">Departamento</h1>
              <p class="text-muted lead mb-0" id="dept-dash-subtitle">Bienvenido al centro de control.</p>
            </div>
            <div class="text-end d-none d-md-block">
              <div class="bg-white p-3 rounded-4 shadow-sm border">
                <span class="d-block text-muted extra-small fw-bold text-uppercase">FECHA DOCTO</span>
                <span class="fs-5 fw-bold text-dark" id="dept-dash-date">--</span>
              </div>
            </div>
          </div>

          <!-- Grid de Módulos (Se llena dinámicamente) -->
          <div class="row g-4" id="dept-dash-grid">
            <!-- Cards inyectadas por JS -->
          </div>

        </div>
      </div>
    </div>

    <div id="view-superadmin-dashboard" class="app-view d-none p-0">
      <div class="d-flex flex-column flex-lg-row min-vh-100">

        <aside class="admin-sidebar bg-dark text-white p-3 d-flex flex-column gap-2 shadow-lg">
          <div class="text-center mb-4 py-3 border-bottom border-secondary">
            <img src="/images/logo-sia.png" width="45" class="mb-2 filter-white">
            <h6 class="fw-bold mb-0">SIA COMMAND</h6>
            <small class="text-warning extra-small">GOD MODE ACTIVE</small>
          </div>

          <nav class="nav nav-pills flex-column gap-2 admin-nav" id="admin-tabs" role="tablist">
            <button class="nav-link active text-start rounded-3" data-bs-toggle="pill" data-bs-target="#sa-tab-general">
              <i class="bi bi-speedometer2 me-2"></i> Vista General
            </button>
            <button class="nav-link text-start rounded-3" data-bs-toggle="pill" data-bs-target="#sa-tab-users"
              id="btn-tab-users">
              <i class="bi bi-people-fill me-2"></i> Gestión de Usuarios
            </button>
            <button class="nav-link text-start rounded-3" data-bs-toggle="pill" data-bs-target="#sa-tab-system">
              <i class="bi bi-gear-wide-connected me-2"></i> Configuración Global
            </button>
            <button class="nav-link text-start rounded-3" data-bs-toggle="pill" data-bs-target="#sa-tab-logs">
              <i class="bi bi-shield-lock-fill me-2"></i> Auditoría (Logs)
            </button>
          </nav>

          <div class="mt-auto p-2 bg-white bg-opacity-10 rounded-3 small">
            <div class="d-flex align-items-center gap-2 mb-1">
              <span class="dot-indicator bg-success"></span>
              <span>Firebase: Online</span>
            </div>
            <small class="text-white-50">SIA v2.5-Command</small>
          </div>
        </aside>

        <main class="flex-grow-1 p-4 bg-surface-muted overflow-auto">
          <div class="tab-content" id="sa-tabs-content">

            <div class="tab-pane fade show active" id="sa-tab-general" role="tabpanel">
              <div class="row g-4 mt-2">
                <div class="col-lg-8">
                  <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                      <h6 class="fw-bold mb-0"><i class="bi bi-graph-up text-primary me-2"></i>Tendencia de Actividad
                        por Módulo</h6>
                      <button class="btn btn-sm btn-light border" onclick="AdminAudit.refreshCharts()"
                        title="Actualizar gráficos">
                        <i class="bi bi-arrow-clockwise"></i>
                      </button>
                    </div>
                    <div class="card-body">
                      <canvas id="chart-activity-trends" style="max-height: 300px;"></canvas>
                    </div>
                  </div>
                </div>
                <div class="col-lg-4">
                  <div class="card border-0 shadow-sm rounded-4 h-100">
                    <div class="card-header bg-white py-3">
                      <h6 class="fw-bold mb-0"><i class="bi bi-pie-chart text-info me-2"></i>Distribución de Usuarios
                      </h6>
                    </div>
                    <div class="card-body d-flex align-items-center">
                      <canvas id="chart-user-distribution"></canvas>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-4">
                <button class="btn btn-success w-100 py-3 rounded-4 shadow-sm fw-bold"
                  onclick="AdminAudit.generateMasterReport()">
                  <i class="bi bi-file-earmark-spreadsheet-fill me-2"></i> Descargar Reporte Consolidado del Sistema
                  (CSV)
                </button>
              </div>
            </div>
            <div class="tab-pane fade" id="sa-tab-users" role="tabpanel">
              <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                  <h5 class="fw-bold mb-0">Directorio Maestro de Usuarios</h5>
                  <div class="d-flex gap-2">
                    <input type="text" id="admin-user-search" class="form-control form-control-sm rounded-pill px-3"
                      placeholder="Buscar matrícula o nombre...">
                    <button class="btn btn-primary btn-sm rounded-pill" data-bs-toggle="tooltip"
                      title="Ayuda: Gestiona los niveles de acceso institucional.">
                      <i class="bi bi-question-circle"></i>
                    </button>
                  </div>
                </div>
                <div class="table-responsive" style="max-height: 70vh;">
                  <table class="table table-hover align-middle mb-0">
                    <thead class="table-light small fw-bold text-muted">
                      <tr>
                        <th>Usuario</th>
                        <th>Matrícula</th>
                        <th>Rol Actual</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody id="sa-users-table-body">
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="tab-pane fade" id="sa-tab-system" role="tabpanel">
              <div class="row g-4">

                <div class="col-lg-7">
                  <div class="card border-0 shadow-sm rounded-4 h-100">
                    <div class="card-header bg-white py-3">
                      <h6 class="fw-bold mb-0"><i class="bi bi-broadcast text-primary me-2"></i>Compositor de Avisos del
                        Sistema</h6>
                    </div>
                    <div class="card-body p-4">
                      <form id="form-global-notice">
                        <div class="mb-3">
                          <label class="form-label small fw-bold">Tipo de Alerta</label>
                          <select id="notice-type" class="form-select" required>
                            <option value="info">📢 Informativo (Azul)</option>
                            <option value="mantenimiento">⚙️ Mantenimiento (Naranja)</option>
                            <option value="emergencia">🚨 EMERGENCIA (Rojo - Persistente)</option>
                          </select>
                        </div>
                        <div class="mb-3">
                          <label class="form-label small fw-bold">Mensaje</label>
                          <textarea id="notice-text" class="form-control" rows="3"
                            placeholder="Escribe el mensaje para toda la comunidad..." required></textarea>
                        </div>
                        <div class="row g-3 mb-4">
                          <div class="col-md-6">
                            <label class="form-label small fw-bold">Caducidad</label>
                            <select id="notice-duration" class="form-select">
                              <option value="60">1 hora</option>
                              <option value="1440" selected>24 horas</option>
                              <option value="10080">1 semana</option>
                              <option value="0">Permanente (Manual)</option>
                            </select>
                          </div>
                          <div class="col-md-6 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100 rounded-pill fw-bold">
                              Publicar Aviso Global
                            </button>
                          </div>
                        </div>
                      </form>

                      <hr>
                      <h6 class="small fw-bold text-muted mb-3">Avisos Activos</h6>
                      <div id="active-global-notices" class="list-group list-group-flush">
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-lg-5">
                  <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-header bg-white py-3">
                      <h6 class="fw-bold mb-0"><i class="bi bi-toggle-on text-danger me-2"></i>Interruptores Maestros
                        (Kill Switches)</h6>
                    </div>
                    <div class="card-body">
                      <p class="extra-small text-muted mb-4">Deshabilitar un módulo mostrará un aviso de mantenimiento y
                        bloqueará el acceso a todos los usuarios.</p>

                      <div class="vstack gap-3" id="kill-switches-container">
                        <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded-3">
                          <div>
                            <div class="fw-bold small">Módulo Medi</div>
                            <div class="extra-small text-muted">Citas y Expedientes</div>
                          </div>
                          <div class="form-check form-switch">
                            <input class="form-check-input switch-module" type="checkbox" data-module="medi" checked>
                          </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded-3">
                          <div>
                            <div class="fw-bold small">Módulo Aula</div>
                            <div class="extra-small text-muted">Cursos y Exámenes</div>
                          </div>
                          <div class="form-check form-switch">
                            <input class="form-check-input switch-module" type="checkbox" data-module="aula" checked>
                          </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded-3">
                          <div>
                            <div class="fw-bold small">Módulo Biblio</div>
                            <div class="extra-small text-muted">Préstamos y Activos</div>
                          </div>
                          <div class="form-check form-switch">
                            <input class="form-check-input switch-module" type="checkbox" data-module="biblio" checked>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-header bg-white py-3">
                      <h6 class="fw-bold mb-0"><i class="bi bi-calendar3 text-info me-2"></i>Ajustes de Servicio Médico
                      </h6>
                    </div>
                    <div class="card-body">
                      <div class="mb-3">
                        <label class="form-label small fw-bold">Duración de Citas (minutos)</label>
                        <select id="config-medi-slot" class="form-select form-select-sm">
                          <option value="20">20 minutos</option>
                          <option value="30">30 minutos</option>
                          <option value="60">1 hora</option>
                        </select>
                      </div>
                      <button class="btn btn-info btn-sm w-100 rounded-pill text-white fw-bold"
                        onclick="AdminSystem.saveMediConfig()">
                        Guardar Configuración Medi
                      </button>
                    </div>
                  </div>
                </div>

              </div>
            </div>
            <div class="tab-pane fade" id="sa-tab-logs" role="tabpanel">
              <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                <div class="card-header bg-dark text-white py-3 d-flex justify-content-between align-items-center">
                  <h5 class="fw-bold mb-0"><i class="bi bi-shield-lock me-2"></i>Bitácora de Seguridad y Auditoría</h5>
                  <div class="d-flex gap-2">
                    <input type="text" id="audit-filter-search" class="form-control form-control-sm border-0"
                      placeholder="Filtrar por acción o admin...">
                    <button class="btn btn-outline-light btn-sm" onclick="AdminAudit.renderLogs()"
                      title="Recargar logs">
                      <i class="bi bi-arrow-clockwise"></i>
                    </button>
                  </div>
                </div>
                <div class="table-responsive" style="max-height: 70vh;">
                  <table class="table table-sm table-hover align-middle mb-0">
                    <thead class="table-light extra-small fw-bold text-muted text-uppercase">
                      <tr>
                        <th>Fecha y Hora</th>
                        <th>Administrador</th>
                        <th>Acción</th>
                        <th>Detalles</th>
                        <th>IP/Origen</th>
                      </tr>
                    </thead>
                    <tbody id="sa-audit-table-body" class="small">
                    </tbody>
                  </table>
                </div>
                <div class="card-footer bg-light py-2 text-center">
                  <small class="text-muted">Se muestran los últimos 200 eventos críticos.</small>
                </div>
              </div>
            </div>

          </div>
        </main>
      </div>
    </div>

    <div class="modal fade" id="modalAdminEditUser" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow">
          <div class="modal-header bg-dark text-white border-0 p-4">
            <h5 class="fw-bold mb-0">Modificar Identidad</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <form id="form-admin-edit-user">
            <input type="hidden" id="edit-user-uid">
            <div class="modal-body p-4">
              <div class="d-flex align-items-center gap-3 mb-4 p-3 bg-light rounded-3">
                <div class="bg-primary text-white rounded-circle p-2 px-3 fw-bold" id="edit-user-initials">--</div>
                <div>
                  <h6 class="fw-bold mb-0" id="edit-user-name">Nombre</h6>
                  <small class="text-muted" id="edit-user-email">email@sia.com</small>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label small fw-bold">Asignar Rol Jerárquico <i class="bi bi-info-circle ms-1"
                    data-bs-toggle="tooltip" title="Define los permisos de Firebase para este usuario."></i></label>
                <select class="form-select" id="edit-user-role" required>
                  <option value="student">Estudiante (Base)</option>
                  <option value="docente">Docente</option>
                  <option value="medico">Servicio Médico</option>
                  <option value="biblio">Biblioteca</option>
                  <option value="aula">Administrador de Aula</option>
                  <option value="superadmin">Super Admin (Control Total)</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label small fw-bold">Estado de Cuenta</label>
                <select class="form-select" id="edit-user-status">
                  <option value="active">Activo</option>
                  <option value="suspended">Suspendido / Bloqueado</option>
                </select>
              </div>
            </div>
            <div class="modal-footer border-0 p-4 pt-0">
              <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-dark rounded-pill px-4 shadow-sm">Aplicar Cambios</button>
            </div>
          </form>
        </div>
      </div>
    </div>



    <div id="view-profile" class="app-view d-none">
      <div class="container-fluid px-0">
        <div class="profile-cover-image rounded-bottom-4 shadow-sm d-flex align-items-end justify-content-end p-3">

        </div>

        <div class="container mt-n5" style="max-width: 1000px; margin-top: -60px;">
          <div class="row">
            <div class="col-lg-4 mb-4 position-relative z-2">
              <div class="text-center">
                <div class="position-relative d-inline-block mb-3">
                  <div id="prof-avatar-container"
                    class="rounded-circle border border-4 border-white shadow bg-primary text-white d-flex align-items-center justify-content-center overflow-hidden"
                    style="width: 120px; height: 120px;">
                    <span id="prof-avatar-initials" class="fs-1 fw-bold">U</span>
                    <img id="prof-avatar-img" src="" class="w-100 h-100 object-fit-cover d-none">
                  </div>
                  <button
                    class="btn btn-sm btn-dark rounded-circle position-absolute bottom-0 end-0 border border-white shadow-sm"
                    onclick="document.getElementById('prof-pic-input').click()" title="Cambiar foto">
                    <i class="bi bi-camera-fill text-white"></i>
                  </button>
                  <input type="file" id="prof-pic-input" accept="image/*">
                </div>

                <h3 class="fw-bold mb-1" id="prof-name">Usuario</h3>
                <p class="text-muted mb-3 small text-uppercase fw-bold" id="prof-role">ESTUDIANTE</p>

                <div
                  class="card border-0 shadow-sm rounded-4 overflow-hidden mb-3 bg-dark text-white text-start p-3 position-relative">
                  <div class="d-flex justify-content-between align-items-center position-relative z-1">
                    <div>
                      <div class="small text-white-50 text-uppercase fw-bold" style="font-size: 0.65rem;">Matrícula
                      </div>
                      <div class="font-monospace fs-5" id="prof-matricula">----</div>
                    </div>
                    <div class="bg-white p-1 rounded">
                      <img id="prof-qr-mini" src="" width="40" height="40">
                    </div>
                  </div>
                  <button
                    class="btn btn-sm btn-outline-light w-100 mt-3 rounded-pill position-relative z-1 stretched-link"
                    onclick="Profile.openDigitalID()">
                    <i class="bi bi-qr-code me-2"></i>Ver Credencial
                  </button>
                </div>
              </div>
            </div>

            <div class="col-lg-8 mt-lg-5 pt-lg-3">
              <div class="row g-3 mb-4">
                <div class="col-4">
                  <div class="kardex-stat-box">
                    <div class="small text-muted fw-bold">PROMEDIO</div>
                    <div class="h4 fw-bold text-primary mb-0">-.-</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="kardex-stat-box">
                    <div class="small text-muted fw-bold">CRÉDITOS</div>
                    <div class="h4 fw-bold text-success mb-0">-</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="kardex-stat-box">
                    <div class="small text-muted fw-bold">SEMESTRE</div>
                    <div class="h4 fw-bold text-dark mb-0">-</div>
                  </div>
                </div>
              </div>

              <div class="card border-0 shadow-sm rounded-4">
                <div class="card-body p-4">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold mb-0">Información Personal</h6>
                    <button type="button" class="btn btn-sm btn-outline-primary rounded-pill"
                      onclick="Profile.toggleEditMode()">
                      <i class="bi bi-pencil-fill me-1"></i>
                      <span class="d-none d-sm-inline">Editar datos</span>
                    </button>
                  </div>
                  <form id="form-profile-edit">

                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label small fw-bold text-muted">Teléfono</label>
                        <input type="tel" class="form-control" id="prof-phone" disabled="">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small fw-bold text-muted">Tipo de Sangre</label>
                        <select class="form-select" id="prof-blood" disabled="">
                          <option value="">Seleccionar</option>
                          <option value="O+">O+</option>
                          <option value="A+">A+</option>
                        </select>
                      </div>
                      <div class="col-md-12">
                        <label class="form-label small fw-bold text-muted">Contacto de Emergencia</label>
                        <input type="text" class="form-control" id="prof-emergency-name" disabled=""
                          placeholder="Nombre">
                      </div>
                      <div class="col-md-12">
                        <label class="form-label small fw-bold text-muted">Tel. Emergencia</label>
                        <input type="tel" class="form-control" id="prof-emergency-tel" disabled="">
                      </div>
                    </div>
                    <div id="prof-edit-actions" class="mt-4 d-none text-end">
                      <button type="button" class="btn btn-light border rounded-pill me-2"
                        onclick="Profile.cancelEdit()">Cancelar</button>
                      <button type="submit" class="btn btn-primary rounded-pill px-4">Guardar Cambios</button>
                    </div>
                  </form>

                  <!-- Configuración de tema removida - Dark Mode permanente -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>



    <div id="view-biblio" class="app-view d-none container py-4">
      <section id="biblio-student" class="d-none">
        <div class="row g-4">
          <div class="col-lg-8 order-2 order-lg-1">
            <div class="card border-0 shadow-sm rounded-4 h-100">
              <div class="card-header bg-surface border-0 pt-4 px-4">
                <h2 class="h5 mb-1 text-primary fw-bold"><i class="bi bi-search me-2"
                    style="color:var(--biblio)"></i>Catálogo</h2>
                <form id="biblio-stu-search-form" class="mt-3">
                  <div class="input-group">
                    <span class="input-group-text bg-surface-muted border-end-0"><i class="bi bi-search"></i></span>
                    <input type="search" id="biblio-stu-search-input"
                      class="form-control bg-surface-muted border-start-0" placeholder="Título, autor o ISBN...">
                  </div>
                </form>
              </div>
              <div class="card-body p-0">
                <div id="biblio-stu-search-results" class="list-group list-group-flush scroll-container p-3">
                  <p class="text-muted p-3 text-center">Utiliza el buscador para encontrar material.</p>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4 order-1 order-lg-2">
            <div class="card border-0 shadow-sm rounded-4 bg-primary text-white mb-3">
              <div class="card-body p-4 position-relative overflow-hidden">
                <i class="bi bi-bookmark-star position-absolute top-0 end-0 opacity-25 m-3 display-1"></i>
                <h5 class="fw-bold position-relative z-1">Mis Préstamos</h5>
                <p class="small opacity-75 position-relative z-1">Revisa fechas de devolución para evitar multas.</p>
              </div>
            </div>
            <div class="card border-0 shadow-sm rounded-4">
              <div class="card-body p-0">
                <div id="biblio-stu-prestamos" class="table-responsive">
                  <p class="text-muted p-3">Cargando...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="biblio-admin" class="d-none">
        <div class="alert alert-info">Panel de Administración Bibliotecaria Cargado</div>
        <ul class="nav nav-tabs mb-3" role="tablist">
          <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab"
              data-bs-target="#tab-biblio-pend" aria-selected="true" role="tab">Pendientes</button></li>
          <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab"
              data-bs-target="#tab-biblio-aprob" aria-selected="false" tabindex="-1" role="tab">Aprobados</button>
          </li>
          <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab"
              data-bs-target="#tab-biblio-entreg" aria-selected="false" tabindex="-1" role="tab">Entregados</button>
          </li>
          <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab"
              data-bs-target="#tab-biblio-invent" aria-selected="false" tabindex="-1" role="tab">Inventario</button>
          </li>
          <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab"
              data-bs-target="#tab-biblio-servicios" aria-selected="false" tabindex="-1" role="tab">Servicios &amp;
              PCs</button></li>
        </ul>
        <div class="tab-content">
          <div class="tab-pane fade show active" id="tab-biblio-pend" role="tabpanel">
            <div id="biblio-adm-prestamos-pend" class="card p-3 border-0 shadow-sm"></div>
          </div>
          <div class="tab-pane fade" id="tab-biblio-aprob" role="tabpanel">
            <div id="biblio-adm-prestamos-aprob" class="card p-3 border-0 shadow-sm"></div>
          </div>
          <div class="tab-pane fade" id="tab-biblio-entreg" role="tabpanel">
            <div id="biblio-adm-prestamos-entreg" class="card p-3 border-0 shadow-sm"></div>
          </div>
          <div class="tab-pane fade" id="tab-biblio-invent" role="tabpanel">
            <div class="row g-4">
              <div class="col-lg-4">
                <div class="card border-0 shadow-sm p-4">
                  <h6>Nuevo Libro</h6>
                  <form id="form-biblio-nuevo-libro">
                    <input class="form-control mb-2" id="biblio-titulo" placeholder="Título" required="">
                    <input class="form-control mb-2" id="biblio-autor" placeholder="Autor" required="">
                    <input class="form-control mb-2" id="biblio-isbn" placeholder="ISBN">
                    <input type="number" class="form-control mb-3" id="biblio-copias" value="1" min="1">
                    <button class="btn btn-primary w-100">Guardar</button>
                  </form>
                </div>
              </div>
              <div class="col-lg-8">
                <div id="biblio-adm-inventario" class="card p-3 border-0 shadow-sm scroll-container"></div>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="tab-biblio-servicios" role="tabpanel">
            <div class="row g-4">
              <div class="col-lg-8">
                <div class="card border-0 shadow-sm">
                  <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0">Control de Activos</h6>
                    <span class="badge bg-primary-subtle text-primary">Tiempo Real</span>
                  </div>
                  <div class="card-body p-0">
                    <div id="biblio-assets-grid" class="row g-0">
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-lg-4">
                <div class="card border-0 shadow-sm p-4 mb-3">
                  <h6 class="fw-bold mb-3">Nuevo Activo</h6>
                  <form id="form-biblio-asset">
                    <div class="mb-2">
                      <label class="small fw-bold text-muted">ID Único (Ej. PC-01)</label>
                      <input type="text" id="asset-id" class="form-control form-control-sm text-uppercase" required="">
                    </div>
                    <div class="mb-2">
                      <label class="small fw-bold text-muted">Tipo</label>
                      <select id="asset-type" class="form-select form-select-sm">
                        <option value="pc">Computadora</option>
                        <option value="sala">Sala de Estudio</option>
                        <option value="mesa">Mesa de Trabajo</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label class="small fw-bold text-muted">Nombre Visible</label>
                      <input type="text" id="asset-name" class="form-control form-control-sm"
                        placeholder="Ej. PC Diseño 1" required="">
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm w-100">Crear Activo</button>
                  </form>
                </div>

                <div id="asset-control-panel" class="card border-0 shadow-sm p-4 bg-light d-none">
                  <h6 class="fw-bold mb-2" id="ctrl-asset-name">--</h6>
                  <p class="small text-muted mb-3" id="ctrl-asset-status">Selecciona un activo</p>

                  <label class="small fw-bold">Asignar tiempo:</label>
                  <div class="d-flex gap-2 mb-3">
                    <button class="btn btn-white border btn-sm flex-fill" onclick="Biblio.quickUnlock(30)">30m</button>
                    <button class="btn btn-white border btn-sm flex-fill" onclick="Biblio.quickUnlock(60)">1h</button>
                    <button class="btn btn-white border btn-sm flex-fill" onclick="Biblio.quickUnlock(120)">2h</button>
                  </div>
                  <input type="text" id="ctrl-user-label" class="form-control form-control-sm mb-3"
                    placeholder="Nombre/Matrícula (Opcional)">

                  <div class="d-grid gap-2">
                    <button class="btn btn-success btn-sm" id="btn-unlock-custom">Desbloquear</button>
                    <button class="btn btn-danger btn-sm" id="btn-force-lock">Bloquear Ahora</button>
                    <button class="btn btn-outline-danger btn-sm" id="btn-delete-asset">Eliminar</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="biblio-superadmin" class="d-none">

        <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden text-white"
          style="background: linear-gradient(135deg, #2563eb 0%, #1e3a8a 100%);">
          <div class="card-body p-4 position-relative">
            <div class="d-flex justify-content-between align-items-center position-relative z-1">
              <div>
                <div class="d-flex align-items-center gap-2 mb-1">
                  <i class="bi bi-cpu-fill fs-4"></i>
                  <h2 class="h4 fw-bold mb-0">BiBlop Control</h2>
                </div>
                <p class="mb-0 opacity-75 small">Monitor de acceso en tiempo real y telemetría de servicios.</p>
              </div>
              <div class="text-end">
                <div class="badge bg-white bg-opacity-25 border border-white border-opacity-25 backdrop-blur mb-1">
                  <span class="dot-indicator bg-success border border-white d-inline-block rounded-circle me-1"
                    style="width:8px; height:8px;"></span>
                  En línea
                </div>
                <div class="small opacity-75" id="biblop-last-update">Actualizando...</div>
              </div>
            </div>
            <i class="bi bi-wifi position-absolute text-white opacity-10"
              style="font-size: 8rem; right: -20px; bottom: -40px;"></i>
          </div>
        </div>

        <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between mb-4">
          <div class="d-flex align-items-center gap-2">
            <label class="small fw-bold text-muted">Rango:</label>
            <select id="biblop-range" class="form-select form-select-sm rounded-pill shadow-sm border-0"
              style="min-width: 150px;">
              <option value="1h">Última hora</option>
              <option value="6h">Últimas 6 horas</option>
              <option value="24h" selected="">Últimas 24 horas</option>
              <option value="7d">Últimos 7 días</option>
              <option value="30d">Últimos 30 días</option>
            </select>
          </div>
          <button class="btn btn-sm btn-outline-primary rounded-pill" id="biblop-refresh-btn">
            <i class="bi bi-arrow-clockwise me-1"></i> Actualizar
          </button>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 p-3 border-start border-4 border-primary">
              <div class="small text-muted fw-bold text-uppercase">Entradas</div>
              <div class="h2 mb-0 fw-bold text-primary" id="biblop-kpi-entro">-</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 p-3 border-start border-4 border-success">
              <div class="small text-muted fw-bold text-uppercase">Salidas</div>
              <div class="h2 mb-0 fw-bold text-success" id="biblop-kpi-salio">-</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 p-3 border-start border-4 border-warning">
              <div class="small text-muted fw-bold text-uppercase">Aforo Actual</div>
              <div class="h2 mb-0 fw-bold text-dark" id="biblop-kpi-inside">-</div>
              <small class="text-muted" style="font-size: 0.7rem;">Estimado</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 p-3">
              <div class="small text-muted fw-bold text-uppercase">Ratio E/S</div>
              <div class="h2 mb-0 fw-bold text-secondary" id="biblop-kpi-ratio">-</div>
            </div>
          </div>
        </div>

        <div class="row g-4 mb-4">
          <div class="col-12">
            <div class="card border-0 shadow-sm rounded-4">
              <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                <h6 class="fw-bold mb-0"><i class="bi bi-bar-chart-line-fill me-2 text-primary"></i>Flujo de Entradas
                  y
                  Salidas</h6>
                <small class="text-muted">Comparativa por intervalo</small>
              </div>
              <div class="card-body">
                <div style="height: 300px; position: relative; width: 100%;">
                  <canvas id="chart-biblop-flow"></canvas>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card border-0 shadow-sm rounded-4 h-100">
              <div class="card-header bg-white py-3 border-0">
                <h6 class="fw-bold mb-0"><i class="bi bi-activity me-2 text-warning"></i>Tendencia de Ocupación</h6>
              </div>
              <div class="card-body">
                <div style="height: 250px; position: relative; width: 100%;">
                  <canvas id="chart-biblop-occupancy"></canvas>
                </div>
                <div class="text-center mt-3 small text-muted">
                  Estimación de aforo a lo largo del tiempo.
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card border-0 shadow-sm rounded-4 h-100">
              <div class="card-header bg-white py-3 border-0">
                <h6 class="fw-bold mb-0"><i class="bi bi-pie-chart-fill me-2 text-info"></i>Distribución de Servicios
                </h6>
              </div>
              <div class="card-body">
                <div class="row align-items-center h-100">
                  <div class="col-md-6">
                    <div style="height: 200px; position: relative; width: 100%;">
                      <canvas id="chart-biblop-services"></canvas>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <ul class="list-group list-group-flush small" id="biblop-services-legend">
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card border-0 shadow-sm rounded-4 mb-5">
          <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
            <h6 class="fw-bold mb-0">Bitácora del Dispositivo</h6>
            <span class="badge bg-light text-dark">Últimos 12 eventos</span>
          </div>
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 small">
              <thead class="table-light">
                <tr>
                  <th>Hora</th>
                  <th>Evento</th>
                  <th>Servicio</th>
                  <th>ID Credencial</th>
                </tr>
              </thead>
              <tbody id="biblop-table-body">
                <tr>
                  <td colspan="4" class="text-center text-muted py-3">Cargando datos...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3 mt-5">
          <h4 class="h5 fw-bold text-muted">Gestión de Inventario</h4>
        </div>
        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <div class="card border-0 shadow-sm p-3">
              <div class="small text-muted fw-bold">INVENTARIO TOTAL</div>
              <div class="h4 mb-0" id="biblio-sa-total">0</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-0 shadow-sm p-3">
              <div class="small text-muted fw-bold">PRÉSTAMOS ACTIVOS</div>
              <div class="h4 mb-0 text-warning" id="biblio-sa-activos">0</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-0 shadow-sm p-3">
              <div class="small text-muted fw-bold">NO DEVUELTOS</div>
              <div class="h4 mb-0 text-danger" id="biblio-sa-vencidos">0</div>
            </div>
          </div>
        </div>
        <div class="card border-0 shadow-sm rounded-4">
          <div class="card-header bg-white py-3">
            <h5 class="mb-0 fw-bold">Préstamos (Firebase)</h5>
          </div>
          <div class="card-body p-0">
            <div id="biblio-sa-list" class="table-responsive scroll-container" style="max-height: 300px;"></div>
          </div>
        </div>

      </section>
    </div>

    <div id="view-medi" class="app-view d-none container py-4">

      <!-- ==================== VISTA ESTUDIANTE ==================== -->
      <div id="medi-student" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h1 class="h3 fw-bold text-primary mb-1">Mi Salud</h1>
            <p class="text-muted mb-0 small">Gestiona tu bienestar y emergencias.</p>
          </div>
          <button class="btn btn-danger btn-sm rounded-pill shadow-sm animate-pulse"
            onclick="if(window.Medi) Medi.toggleSOS()">
            <i class="bi bi-exclamation-triangle-fill me-1"></i> SOS
          </button>
        </div>

        <ul class="nav nav-pills mb-4 gap-2" role="tablist">
          <li class="nav-item">
            <button class="nav-link active rounded-pill px-4" data-bs-toggle="pill" data-bs-target="#tab-medi-resumen">
              <i class="bi bi-heart-pulse me-2"></i>Resumen
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link rounded-pill px-4" data-bs-toggle="pill" data-bs-target="#tab-medi-citas">
              <i class="bi bi-calendar-event me-2"></i>Citas
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link rounded-pill px-4" data-bs-toggle="pill" data-bs-target="#tab-medi-expediente">
              <i class="bi bi-folder2-open me-2"></i>Expediente
            </button>
          </li>
        </ul>

        <div class="tab-content">
          <!-- TAB 1: RESUMEN (Tarjeta + Feed) -->
          <div class="tab-pane fade show active" id="tab-medi-resumen">
            <div class="row g-4">
              <div class="col-lg-5">
                <div class="card border-0 shadow-sm rounded-4 mb-3 bg-white overflow-hidden">
                  <div
                    class="card-header bg-danger text-white border-0 py-3 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold"><i class="bi bi-postcard-heart-fill me-2"></i>Tarjeta de Emergencia</h6>
                    <button class="btn btn-sm btn-white text-danger py-0" style="font-size:0.7rem"
                      onclick="Medi.editarTarjeta()">Editar</button>
                  </div>
                  <div class="card-body position-relative">
                    <div id="medi-card-view">
                      <div class="row g-2 text-center mb-3">
                        <div class="col-6">
                          <div class="p-2 bg-light rounded-3 border">
                            <div class="extra-small text-muted text-uppercase fw-bold">Tipo Sangre</div>
                            <div class="h4 mb-0 fw-bold text-dark" id="view-sangre">--</div>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="p-2 bg-light rounded-3 border">
                            <div class="extra-small text-muted text-uppercase fw-bold">Alergias</div>
                            <div class="small fw-semibold text-dark text-truncate" id="view-alergias">Ninguna</div>
                          </div>
                        </div>
                      </div>
                      <div class="p-3 bg-danger-subtle text-danger rounded-3 border border-danger-subtle">
                        <div class="extra-small text-uppercase fw-bold opacity-75">Contacto de Emergencia</div>
                        <div class="fw-bold" id="view-contacto-nombre">--</div>
                        <div class="small"><i class="bi bi-telephone-fill me-1"></i> <span
                            id="view-contacto-tel">--</span></div>
                      </div>
                    </div>

                    <form id="medi-card-form" class="d-none">
                      <div class="mb-2">
                        <label class="form-label extra-small fw-bold">Tipo de Sangre</label>
                        <select class="form-select form-select-sm" id="edit-sangre">
                          <option value="">Seleccionar</option>
                          <option value="A+">A+</option>
                          <option value="A-">A-</option>
                          <option value="B+">B+</option>
                          <option value="B-">B-</option>
                          <option value="AB+">AB+</option>
                          <option value="AB-">AB-</option>
                          <option value="O+">O+</option>
                          <option value="O-">O-</option>
                        </select>
                      </div>
                      <div class="mb-2">
                        <label class="form-label extra-small fw-bold">Alergias</label>
                        <input type="text" class="form-control form-control-sm" id="edit-alergias"
                          placeholder="Ej. Penicilina">
                      </div>
                      <div class="mb-2">
                        <label class="form-label extra-small fw-bold">Nombre Contacto</label>
                        <input type="text" class="form-control form-control-sm" id="edit-contacto-nombre">
                      </div>
                      <div class="mb-3">
                        <label class="form-label extra-small fw-bold">Teléfono Contacto</label>
                        <input type="tel" class="form-control form-control-sm" id="edit-contacto-tel">
                      </div>
                      <div class="d-flex gap-2">
                        <button type="button" class="btn btn-light btn-sm w-50"
                          onclick="Medi.cancelarEdicionTarjeta()">Cancelar</button>
                        <button type="submit" class="btn btn-primary btn-sm w-50">Guardar</button>
                      </div>
                    </form>
                  </div>
                </div>

                <div class="d-grid">
                  <button class="btn btn-outline-primary py-3 rounded-4 fw-bold shadow-sm"
                    onclick="document.querySelector('[data-bs-target=\'#tab-medi-citas\']').click()">
                    <i class="bi bi-calendar-plus me-2"></i> Agendar Nueva Cita
                  </button>
                </div>
              </div>

              <div class="col-lg-7">
                <h6 class="fw-bold text-muted mb-3"><i class="bi bi-stars me-2"></i>Tu Feed de Bienestar</h6>
                <div id="medi-recos" class="row g-3"></div>
              </div>
            </div>
          </div>

          <!-- TAB 2: CITAS Y AGENDA -->
          <div class="tab-pane fade" id="tab-medi-citas">
            <div class="row g-4">
              <div class="col-lg-5">
                <div class="card border-0 shadow-sm rounded-4">
                  <div class="card-body p-4">
                    <div class="d-flex align-items-center gap-3 mb-4">
                      <div class="bg-info-subtle text-info rounded-circle p-3"><i class="bi bi-calendar-plus fs-4"></i>
                      </div>
                      <h2 class="h5 mb-0 fw-bold">Agendar Cita</h2>
                    </div>
                    <form id="form-medi-nueva-cita">
                      <div class="mb-3">
                        <label class="form-label small fw-bold text-muted text-uppercase">1. Motivo de visita</label>
                        <div class="input-group shadow-sm rounded-3 overflow-hidden">
                          <span class="input-group-text bg-white border-end-0"><i
                              class="bi bi-list-check text-primary"></i></span>
                          <select id="medi-cita-categoria" class="form-select border-start-0 ps-0" required
                            style="cursor: pointer;">
                            <option value="" selected disabled>Selecciona una opción...</option>
                            <option value="Malestar Físico">Me siento mal físicamente</option>
                            <option value="Salud Mental">Apoyo emocional / Psicológico</option>
                            <option value="Certificado">Trámite / Certificado</option>
                            <option value="Consulta General">Consulta General</option>
                          </select>
                        </div>
                      </div>
                      <div class="mb-3">
                        <label class="form-label small fw-bold text-muted text-uppercase">2. Fecha deseada</label>
                        <div class="input-group shadow-sm rounded-3 overflow-hidden">
                          <span class="input-group-text bg-white border-end-0"><i
                              class="bi bi-calendar-event text-primary"></i></span>
                          <input type="date" id="medi-cita-fecha" class="form-control border-start-0 ps-0" required>
                        </div>
                      </div>
                      <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <label class="form-label small fw-bold text-muted text-uppercase mb-0">3. Horario
                            disponible</label>
                          <div id="medi-cita-disponibilidad" class="badge bg-light text-secondary border">Selecciona
                            fecha
                          </div>
                        </div>
                        <div id="medi-time-grid" class="time-slot-grid p-2 bg-light rounded-3 border d-none"></div>
                        <div id="medi-time-msg" class="text-center text-muted small py-3 border rounded-3 bg-light">
                          <i class="bi bi-arrow-up-circle me-1"></i> Elige una fecha arriba.
                        </div>
                        <input type="hidden" id="medi-cita-hora" required>
                      </div>
                      <input type="hidden" id="medi-cita-tipo" value="Medico">
                      <div class="form-floating mb-4">
                        <textarea id="medi-cita-motivo" class="form-control shadow-sm"
                          style="height: 80px; border-radius: 1rem;" placeholder="Detalles" required></textarea>
                        <label class="text-muted">Describe brevemente tus síntomas...</label>
                      </div>
                      <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow hover-scale">
                        <i class="bi bi-check-circle-fill me-2"></i> Confirmar Cita
                      </button>
                    </form>
                  </div>
                </div>
              </div>
              <div class="col-lg-7">
                <div class="card border-0 shadow-sm rounded-4 h-100">
                  <div class="card-header bg-white border-0 pt-4 px-4">
                    <h6 class="fw-bold mb-0">Mis Citas Activas</h6>
                  </div>
                  <div class="card-body p-0">
                    <div id="medi-stu-citas" class="table-responsive p-3"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- TAB 3: EXPEDIENTE -->
          <div class="tab-pane fade" id="tab-medi-expediente">
            <div class="card border-0 shadow-sm rounded-4">
              <div class="card-header bg-white border-0 pt-4 px-4">
                <h5 class="fw-bold mb-0">Mi Historial Clínico</h5>
                <small class="text-muted">Registro histórico de consultas y recetas.</small>
              </div>
              <div class="card-body">
                <div id="medi-stu-consultas"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== VISTA ADMIN (MÉDICO/PSICÓLOGO) ==================== -->
      <section id="medi-admin" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h2 class="h4 fw-bold text-primary mb-1">Estación Médica</h2>
            <div class="d-flex gap-2 align-items-center">
              <span id="medi-pro-name" class="fw-bold large">Profesional</span>
              <span id="medi-pro-esp" class="badge bg-info text-dark">General</span>
            </div>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm rounded-pill" onclick="Medi.refreshAdmin()">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
            <button class="btn btn-primary btn-sm shadow-sm rounded-pill px-3" onclick="Medi.nuevaConsultaWalkIn()">
              <i class="bi bi-plus-lg me-1"></i> Consulta Express
            </button>
          </div>
        </div>

        <ul class="nav nav-pills mb-4 gap-2" role="tablist">
          <li class="nav-item">
            <button class="nav-link active rounded-pill px-4" data-bs-toggle="pill" data-bs-target="#adm-tab-sala">
              <i class="bi bi-clipboard-data me-2"></i>Sala de Espera
              <span class="badge bg-danger ms-2 rounded-pill" id="badge-sala-espera">0</span>
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link rounded-pill px-4" data-bs-toggle="pill" data-bs-target="#adm-tab-agenda">
              <i class="bi bi-calendar-check me-2"></i>Mi Agenda
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link rounded-pill px-4" data-bs-toggle="pill" data-bs-target="#adm-tab-pacientes">
              <i class="bi bi-people me-2"></i>Pacientes
            </button>
          </li>
          <li class="nav-item ms-auto">
            <button class="nav-link rounded-pill px-3 bg-light text-secondary" data-bs-toggle="pill"
              data-bs-target="#adm-tab-config">
              <i class="bi bi-gear-fill"></i>
            </button>
          </li>
        </ul>

        <div class="tab-content">
          <!-- ADMIN TAB 1: SALA DE ESPERA -->
          <div class="tab-pane fade show active" id="adm-tab-sala">
            <div class="row g-4">
              <div class="col-lg-8">
                <div class="card border-0 shadow-sm rounded-4 h-100">
                  <div class="card-header bg-white border-0 pt-4 px-4 d-flex justify-content-between">
                    <div>
                      <h5 class="fw-bold mb-0">Pacientes en Espera</h5>
                      <small class="text-muted">Solicitudes en tiempo real</small>
                    </div>
                    <div class="form-check form-switch ps-0">
                      <label class="form-check-label small fw-bold text-success me-5 pe-2"
                        for="medi-switch-disponibilidad" style="cursor: pointer;">Recibir Citas</label>
                      <input class="form-check-input ms-0" style="width: 3em; height: 1.5em; cursor: pointer;"
                        type="checkbox" id="medi-switch-disponibilidad" checked
                        onchange="Medi.toggleAvailability(this.checked)">
                    </div>
                  </div>
                  <div class="card-body p-0">
                    <div id="medi-muro-list" class="list-group list-group-flush p-3">
                      <div class="text-center p-5 text-muted">No hay pacientes en espera.</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-lg-4">
                <!-- KPI Rápido -->
                <div class="row g-3 mb-3">
                  <div class="col-6">
                    <div class="p-3 bg-white rounded-4 shadow-sm border text-center">
                      <div class="h4 fw-bold text-success mb-0" id="kpi-atendidos-hoy">0</div>
                      <div class="extra-small text-uppercase text-muted fw-bold">Atendidos</div>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="p-3 bg-white rounded-4 shadow-sm border text-center">
                      <div class="h4 fw-bold text-warning mb-0" id="kpi-pendientes-hoy">0</div>
                      <div class="extra-small text-uppercase text-muted fw-bold">Pendientes</div>
                    </div>
                  </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 bg-primary text-white mb-4">
                  <div class="card-body p-4">
                    <h5 class="fw-bold"><i class="bi bi-lightning-charge-fill me-2"></i>Acción Rápida</h5>
                    <p class="small opacity-75 mb-3">Registrar paciente presencial sin cita previa.</p>
                    <button class="btn btn-white text-primary w-100 fw-bold rounded-pill shadow-sm"
                      onclick="Medi.nuevaConsultaWalkIn()">
                      Atender Ahora
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ADMIN TAB 2: AGENDA -->
          <div class="tab-pane fade" id="adm-tab-agenda">
            <div class="card border-0 shadow-sm rounded-4">
              <div class="card-header bg-white border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0">Agenda Personal</h5>
                <select class="form-select form-select-sm w-auto rounded-pill border-0 bg-light fw-bold text-secondary">
                  <option>Esta Semana</option>
                  <option>Hoy</option>
                </select>
              </div>
              <div class="card-body p-0">
                <div id="medi-agenda-list" class="table-responsive"></div>
              </div>
            </div>
          </div>

          <!-- ADMIN TAB 3: PACIENTES -->
          <div class="tab-pane fade" id="adm-tab-pacientes">
            <div class="card border-0 shadow-sm rounded-4">
              <div class="card-body p-4">
                <h5 class="fw-bold mb-3">Expediente Digital</h5>
                <div class="input-group mb-4 shadow-sm rounded-pill overflow-hidden border-0">
                  <span class="input-group-text bg-white border-0 ps-4"><i class="bi bi-search text-muted"></i></span>
                  <input type="text" class="form-control border-0 py-3" id="medi-search-paciente"
                    placeholder="Buscar por matrícula, nombre o correo del estudiante...">
                </div>
                <div id="medi-pacientes-results">
                  <div class="text-center py-5 opacity-50">
                    <i class="bi bi-person-badge display-1 mb-3"></i>
                    <p>Busca un estudiante para ver su historial o iniciar consulta.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ADMIN TAB 4: CONFIGURACIÓN -->
          <div class="tab-pane fade" id="adm-tab-config">
            <div class="row g-4 justify-content-center">
              <div class="col-md-8">
                <div class="card border-0 shadow-sm rounded-4">
                  <div class="card-header bg-white border-0 pt-4 px-4">
                    <h5 class="fw-bold mb-0">Configuración del Servicio</h5>
                    <small class="text-muted">Ajusta tus horarios y disponibilidad.</small>
                  </div>
                  <div class="card-body p-4">
                    <form onsubmit="event.preventDefault(); Medi.saveConfig();">
                      <div class="mb-4">
                        <label class="form-label fw-bold small text-muted text-uppercase">Horario de Atención</label>
                        <div class="input-group">
                          <span class="input-group-text bg-light border-0">De</span>
                          <select id="cfg-hora-inicio" class="form-select border-0 bg-light">
                            <option value="7">07:00 AM</option>
                            <option value="8" selected>08:00 AM</option>
                            <option value="9">09:00 AM</option>
                          </select>
                          <span class="input-group-text bg-light border-0">a</span>
                          <select id="cfg-hora-fin" class="form-select border-0 bg-light">
                            <option value="14">02:00 PM</option>
                            <option value="16">04:00 PM</option>
                            <option value="18">06:00 PM</option>
                            <option value="20" selected>08:00 PM</option>
                          </select>
                        </div>
                      </div>

                      <div class="mb-4">
                        <label class="form-label fw-bold small text-muted text-uppercase">Duración de Consulta</label>
                        <div class="btn-group w-100" role="group">
                          <input type="radio" class="btn-check" name="cfg-duracion" id="dur-15" value="15">
                          <label class="btn btn-outline-secondary" for="dur-15">15 min</label>

                          <input type="radio" class="btn-check" name="cfg-duracion" id="dur-30" value="30" checked>
                          <label class="btn btn-outline-secondary" for="dur-30">30 min</label>

                          <input type="radio" class="btn-check" name="cfg-duracion" id="dur-60" value="60">
                          <label class="btn btn-outline-secondary" for="dur-60">1h</label>
                        </div>
                      </div>

                      <hr class="opacity-10 my-4">

                      <div class="d-flex justify-content-end align-items-center">
                        <button type="submit" class="btn btn-primary rounded-pill px-4 shadow-sm fw-bold">
                          Guardar Configuración
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- ==================== VISTA SUPERADMIN (GLOBAL) ==================== -->
      <section id="medi-superadmin" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="h4 fw-bold text-primary mb-0">Supervisión Médica</h2>
          <span class="badge bg-info text-dark">Vista Global</span>
        </div>
        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <div class="card border-0 shadow-sm p-3 border-start border-4 border-info">
              <div class="small text-muted fw-bold">CONSULTAS MÉDICAS (MES)</div>
              <div class="h3 mb-0" id="medi-sa-medico">0</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card border-0 shadow-sm p-3 border-start border-4 border-primary">
              <div class="small text-muted fw-bold">ATENCIÓN PSICOLÓGICA (MES)</div>
              <div class="h3 mb-0" id="medi-sa-psico">0</div>
            </div>
          </div>
        </div>
        <div class="card border-0 shadow-sm rounded-4">
          <div class="card-header bg-white py-3 d-flex justify-content-between">
            <h5 class="mb-0 fw-bold">Bitácora de Atención</h5>
            <small class="text-muted">Últimos 50 registros</small>
          </div>
          <div class="card-body p-0">
            <div id="medi-sa-list" class="table-responsive scroll-container" style="max-height: 500px;"></div>
          </div>
        </div>
      </section>

      <!-- ==================== MODALS MEDI ==================== -->
      <!-- Modal SOS -->
      <div class="modal fade" id="modalSOS" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content border-0 rounded-4 overflow-hidden">
            <div class="modal-header bg-danger text-white border-0">
              <h5 class="modal-title fw-bold"><i class="bi bi-shield-exclamation me-2"></i>Ayuda de Emergencia</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-4">
              <p class="text-muted mb-4">Si estás en el campus y requieres asistencia inmediata:</p>
              <div class="d-grid gap-3">
                <a href="tel:911" class="btn btn-outline-danger btn-lg fw-bold rounded-pill">
                  <i class="bi bi-telephone-fill me-2"></i> Llamar al 911
                </a>
                <a href="tel:1234567890" class="btn btn-danger btn-lg fw-bold rounded-pill shadow">
                  <i class="bi bi-hospital-fill me-2"></i> Enfermería Campus
                </a>
              </div>
              <div class="mt-4 p-3 bg-light rounded-3 text-start">
                <h6 class="fw-bold text-dark small mb-2">Ubicación Enfermería:</h6>
                <p class="mb-0 small text-muted"><i class="bi bi-geo-alt-fill me-1"></i> Edificio B, Planta Baja
                  (Junto
                  a
                  cafetería).</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Consulta SOAP -->
      <div class="modal fade" id="modalConsultaSOAP" tabindex="-1" data-bs-backdrop="static" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content rounded-4 border-0">
            <div class="modal-header bg-primary text-white border-0">
              <div>
                <h5 class="modal-title fw-bold" id="soap-modal-title">Consulta Médica</h5>
                <div class="small opacity-75" id="soap-patient-info">Cargando paciente...</div>
              </div>
              <div class="d-flex gap-2 align-items-center">
                <button type="button" class="btn btn-white text-primary btn-sm rounded-pill fw-bold"
                  data-bs-dismiss="modal">
                  <i class="bi bi-pause-circle-fill me-1"></i> Pausar
                </button>
                <button type="button" class="btn btn-success btn-sm rounded-pill fw-bold shadow-sm"
                  onclick="Medi.saveConsultation(event)">
                  <i class="bi bi-check-circle-fill me-1"></i> Finalizar
                </button>
                <button type="button" class="btn-close btn-close-white ms-2" data-bs-dismiss="modal"></button>
              </div>
            </div>
            <div class="modal-body bg-surface-muted p-0">
              <div class="row g-0 h-100">
                <div class="col-lg-4 border-end bg-white d-flex flex-column" style="max-height: 80vh;">
                  <div class="p-3 border-bottom bg-light">
                    <h6 class="fw-bold mb-0 text-primary"><i class="bi bi-clock-history me-2"></i>Historial Clínico
                    </h6>
                  </div>
                  <div id="soap-history-list" class="flex-grow-1 overflow-auto p-3"></div>
                </div>
                <div class="col-lg-8 d-flex flex-column" style="max-height: 80vh; overflow-y: auto;">
                  <form id="form-soap" class="p-4" onsubmit="return false;">
                    <input type="hidden" id="soap-cita-id">
                    <input type="hidden" id="soap-student-id">
                    <input type="hidden" id="soap-student-email">
                    <div class="mb-4">
                      <label class="small fw-bold text-muted text-uppercase mb-2">Subjetivo (Motivo de
                        consulta)</label>
                      <textarea class="form-control bg-white shadow-sm border-0" id="soap-s" rows="3"
                        placeholder="¿Qué refiere el paciente?" required></textarea>
                    </div>
                    <div class="mb-4">
                      <label class="small fw-bold text-muted text-uppercase mb-2">Objetivo (Signos Vitales)</label>
                      <div class="card border-0 shadow-sm p-3 bg-white">
                        <div class="row g-3">
                          <div class="col-md-3"><label class="form-label small">Temp (°C)</label><input type="number"
                              step="0.1" class="form-control form-control-sm" id="soap-temp"></div>
                          <div class="col-md-3"><label class="form-label small">Presión (mmHg)</label><input type="text"
                              class="form-control form-control-sm" id="soap-presion" placeholder="120/80">
                          </div>
                          <div class="col-md-3"><label class="form-label small">Peso (kg)</label><input type="number"
                              step="0.1" class="form-control form-control-sm" id="soap-peso"></div>
                          <div class="col-md-3"><label class="form-label small">Talla (cm)</label><input type="number"
                              class="form-control form-control-sm" id="soap-talla"></div>
                        </div>
                      </div>
                    </div>
                    <div class="mb-4">
                      <label class="small fw-bold text-muted text-uppercase mb-2">Análisis (Diagnóstico)</label>
                      <textarea class="form-control bg-white shadow-sm border-0" id="soap-a" rows="2"
                        placeholder="Conclusión diagnóstica..."></textarea>
                    </div>
                    <div class="mb-4">
                      <label class="small fw-bold text-muted text-uppercase mb-2">Plan (Indicaciones
                        Generales)</label>
                      <textarea class="form-control bg-white shadow-sm border-0" id="soap-p" rows="3"
                        placeholder="Reposo, dieta, cuidados generales..."></textarea>
                    </div>
                    <div class="mb-4">
                      <label class="small fw-bold text-muted text-uppercase mb-2 text-primary"><i
                          class="bi bi-capsule me-1"></i>Medicamentos / Receta</label>
                      <textarea class="form-control bg-white shadow-sm border-0" id="soap-meds" rows="4"
                        placeholder="Ej: Paracetamol 500mg - 1 tableta cada 8 horas por 3 días..."></textarea>
                      <div class="form-text small">Esto aparecerá en la receta PDF.</div>
                    </div>
                    <div class="form-check form-switch mb-4">
                      <input class="form-check-input" type="checkbox" id="soap-visible" checked>
                      <label class="form-check-label small" for="soap-visible">Hacer visible el Plan/Receta al
                        paciente
                        (en su app)</label>
                    </div>
                    <div class="d-grid">
                      <!-- Buttons moved to Header -->
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Success Consulta -->
      <div class="modal fade" id="modalConsultaSuccess" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-sm modal-dialog-centered">
          <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="modal-body text-center p-4">
              <div class="mb-3 text-success"><i class="bi bi-check-circle-fill display-1"></i></div>
              <h5 class="fw-bold mb-3">¡Consulta Guardada!</h5>
              <p class="small text-muted mb-4">La consulta se ha registrado correctamente.</p>
              <div class="d-grid gap-2">
                <button class="btn btn-primary rounded-pill" onclick="Medi.printReceta()"><i
                    class="bi bi-printer-fill me-2"></i>Imprimir Receta</button>
                <button class="btn btn-outline-primary rounded-pill" onclick="Medi.sendToPatient()"><i
                    class="bi bi-send-fill me-2"></i>Enviar a Paciente</button>
                <button class="btn btn-light rounded-pill text-muted" data-bs-dismiss="modal">Cerrar</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Detalle Consulta (Estudiante) -->
      <div class="modal fade" id="modalDetalleConsulta" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content rounded-4 border-0">
            <div class="modal-header bg-light border-0">
              <h5 class="modal-title fw-bold text-primary">Detalle de Consulta</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
              <div class="d-flex justify-content-between mb-4">
                <div>
                  <div class="small text-muted text-uppercase">Fecha</div>
                  <div class="fw-bold" id="detail-date">--</div>
                </div>
                <div class="text-end">
                  <div class="small text-muted text-uppercase">Servicio</div><span class="badge bg-primary"
                    id="detail-service">--</span>
                </div>
              </div>
              <div class="mb-3">
                <div class="small text-muted text-uppercase fw-bold">Diagnóstico</div>
                <div class="p-3 bg-light rounded-3 mt-1" id="detail-diagnosis">--</div>
              </div>
              <div class="mb-3">
                <div class="small text-muted text-uppercase fw-bold">Plan / Indicaciones</div>
                <div class="p-3 bg-light rounded-3 mt-1" id="detail-plan">--</div>
              </div>
              <div id="detail-meds-container" class="d-none mb-4">
                <div class="small text-muted text-uppercase fw-bold text-primary"><i
                    class="bi bi-capsule me-1"></i>Medicamentos Recetados</div>
                <div class="p-3 bg-primary-subtle text-primary-emphasis rounded-3 mt-1 border border-primary-subtle"
                  id="detail-meds">--</div>
              </div>
              <hr>
              <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-light border" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary shadow-sm d-none" id="btn-download-receta"><i
                    class="bi bi-file-earmark-pdf-fill me-2"></i>Descargar Receta</button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
    </main>
  </div>

  <section id="view-aula-course" class="app-view d-none container my-4 mb-5">
    <div class="d-flex align-items-center mb-3 gap-3">
      <button class="btn btn-light border shadow-sm rounded-circle" id="aula-course-back"><i
          class="bi bi-arrow-left"></i></button>
      <div class="flex-grow-1">
        <h4 id="aula-course-title" class="mb-0 fw-bold text-primary">Cargando...</h4>
        <p id="aula-course-desc" class="text-muted small mb-0 mt-1"></p>
      </div>
    </div>
    <p id="aula-course-meta" class="text-muted small mb-3"></p>

    <div class="row g-4">
      <aside class="col-lg-4 order-2 order-lg-1">
        <div class="card border-0 shadow-sm rounded-4 p-3 mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="small fw-bold text-muted">Tu Progreso</label>
            <span id="aula-course-streak" class="d-none aula-streak-badge aula-streak-badge-sm">
              <i class="bi bi-fire"></i><span id="aula-course-streak-count">0</span>
            </span>
          </div>
          <div class="progress rounded-pill" style="height:8px;">
            <div id="aula-course-progress" class="progress-bar bg-aula rounded-pill" style="width:0%"></div>
          </div>
          <span id="aula-course-progress-label" class="small text-muted mt-2 d-block">0% completado</span>
          <button class="btn btn-outline-primary w-100 mt-3 rounded-pill" id="aula-course-resume" disabled>Reanudar
            leccion</button>
          <button class="btn btn-primary w-100 mt-2 rounded-pill" id="aula-course-open-quiz" disabled>
            <i class="bi bi-pencil-square me-1"></i>Evaluacion Final
          </button>
        </div>
        <div class="card border-0 shadow-sm rounded-4 mb-3">
          <div class="card-header bg-surface fw-bold border-0 d-flex justify-content-between align-items-center">
            <span><i class="bi bi-list-nested me-2"></i>Temario</span>
            <span id="aula-course-lesson-count" class="badge bg-secondary-subtle text-secondary small"></span>
          </div>
          <div id="aula-course-modules" class="accordion accordion-flush scroll-container"
            style="max-height:450px;overflow-y:auto;"></div>
        </div>
      </aside>
      <main class="col-lg-8 order-1 order-lg-2">
        <div class="card border-0 shadow-sm rounded-4" style="min-height:500px;">
          <div class="card-body p-4 p-lg-5" id="aula-lesson-container">
            <div class="text-center text-muted mt-5">
              <i class="bi bi-journal-text fs-1 opacity-25 d-block mb-3"></i>
              Selecciona una leccion para comenzar.
            </div>
          </div>
          <div class="card-footer bg-surface border-top p-3 d-flex justify-content-between">
            <button class="btn btn-outline-secondary rounded-pill" id="aula-lesson-prev"><i
                class="bi bi-chevron-left me-1"></i>Anterior</button>
            <div class="d-flex gap-2">
              <button class="btn btn-success text-white rounded-pill" id="aula-lesson-complete"><i
                  class="bi bi-check2 me-1"></i>Completar</button>
              <button class="btn btn-primary rounded-pill" id="aula-lesson-next">Siguiente<i
                  class="bi bi-chevron-right ms-1"></i></button>
            </div>
          </div>
        </div>
      </main>
    </div>
  </section>


  <!-- NUEVA VISTA: Verificación de constancias -->
  <div id="verify-shell" class="d-none">
    <main class="min-vh-100 d-flex align-items-center bg-surface-muted py-5">
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-lg-8">
            <div class="card border-0 shadow-sm rounded-4">
              <div class="card-body p-4 p-md-5">

                <div class="d-flex justify-content-between align-items-center mb-3">
                  <div>
                    <h1 class="h5 fw-bold text-primary mb-1">
                      <i class="bi bi-shield-check me-2"></i>
                      Verificación de Constancia
                    </h1>
                    <p class="small text-muted mb-0">
                      Validación electrónica emitida por SIA — TecNM Campus Los Cabos.
                    </p>
                  </div>
                  <span id="verify-badge" class="badge bg-secondary-subtle text-secondary">
                    Pendiente
                  </span>
                </div>

                <!-- Estado: cargando -->
                <div id="verify-loading" class="text-center py-5">
                  <div class="spinner-border text-primary mb-3"></div>
                  <div class="small text-muted">Consultando información...</div>
                </div>

                <!-- Estado: constancia válida -->
                <div id="verify-ok" class="d-none"></div>

                <!-- Estado: error / no encontrada -->
                <div id="verify-error" class="d-none"></div>

                <div class="mt-4 d-flex justify-content-between align-items-center small text-muted">
                  <span>© 2025 Sistema de Integración Académico (SIA)</span>
                  <a href="/" class="text-decoration-none" id="verify-back-link">
                    Volver al inicio
                  </a>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div class="modal fade" id="modal-consulta" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content rounded-4 border-0">
        <div class="modal-header border-0">
          <h5 class="modal-title fw-bold">Detalle</h5><button type="button" class="btn-close"
            data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body bg-surface-muted">
          <div id="modal-consulta-body" class="bg-surface p-3 rounded shadow-sm"></div>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal Aula: Crear / editar curso -->
  <div class="modal fade" id="modalAulaCourse" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content rounded-4 border-0">
        <div class="modal-header border-0">
          <h5 class="modal-title fw-bold" id="aula-course-modal-title">
            <i class="bi bi-journal-plus me-2"></i> Crear curso
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <form id="aula-course-form">
          <input type="hidden" id="aula-course-id">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label small fw-semibold">Titulo del curso</label>
              <input type="text" id="aula-modal-course-title" class="form-control" placeholder="Ej. Redes CISCO Nivel 1"
                required>
            </div>
            <div class="mb-3">
              <label class="form-label small fw-semibold">Descripcion breve</label>
              <textarea id="aula-modal-course-desc" class="form-control" rows="2"
                placeholder="Objetivo del curso..."></textarea>
            </div>
            <div class="row g-3 mb-3">
              <div class="col-md-3">
                <label class="form-label small fw-semibold">Horas</label>
                <input type="number" id="aula-modal-course-hours" class="form-control" min="1" step="1" value="1"
                  required>
              </div>
              <div class="col-md-4">
                <label class="form-label small fw-semibold">Nivel</label>
                <select id="aula-modal-course-level" class="form-select">
                  <option value="General">General</option>
                  <option value="Basico">Basico</option>
                  <option value="Intermedio">Intermedio</option>
                  <option value="Avanzado">Avanzado</option>
                </select>
              </div>
              <div class="col-md-5">
                <label class="form-label small fw-semibold">Imagen (URL)</label>
                <input type="url" id="aula-modal-course-image" class="form-control" placeholder="https://...">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label small fw-semibold">Tags</label>
              <input type="text" id="aula-modal-course-tags" class="form-control"
                placeholder="cisco, redes, networking (separados por coma)">
              <div class="form-text">Separar con comas. Ayudan a los estudiantes a encontrar el curso.</div>
            </div>
            <div class="mb-3">
              <label class="form-label small fw-semibold">Publico objetivo</label>
              <div id="course-publico-group" class="d-flex flex-wrap gap-2">
                <div class="form-check form-check-inline">
                  <input class="form-check-input course-publico-chk" type="checkbox" id="course-publico-all"
                    value="todos" checked>
                  <label class="form-check-label" for="course-publico-all">Todos</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input course-publico-chk" type="checkbox" id="course-publico-stu"
                    value="estudiantes">
                  <label class="form-check-label" for="course-publico-stu">Estudiantes</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input course-publico-chk" type="checkbox" id="course-publico-doc"
                    value="docentes">
                  <label class="form-check-label" for="course-publico-doc">Docentes</label>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i>Guardar curso</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalAulaContent" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content rounded-4">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Editor de Contenido</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-lg-4 border-end">
              <label class="form-label fw-bold small">Curso</label>
              <select id="ac-curso-select" class="form-select form-select-sm mb-3"></select>
              <div class="nav flex-column nav-pills me-3" role="tablist">
                <button class="nav-link active text-start" data-bs-toggle="pill" data-bs-target="#ac-tab-mod"
                  role="tab"><i class="bi bi-folder2 me-2"></i>Modulos</button>
                <button class="nav-link text-start" data-bs-toggle="pill" data-bs-target="#ac-tab-lec" role="tab"><i
                    class="bi bi-file-text me-2"></i>Lecciones</button>
                <button class="nav-link text-start" data-bs-toggle="pill" data-bs-target="#ac-tab-quiz" role="tab"><i
                    class="bi bi-check2-square me-2"></i>Quiz</button>
              </div>
            </div>
            <div class="col-lg-8">
              <div class="tab-content p-3">
                <!-- TAB: Modulos -->
                <div class="tab-pane fade show active" id="ac-tab-mod" role="tabpanel">
                  <form id="ac-module-form">
                    <input type="hidden" id="ac-module-id">
                    <div class="row g-2 mb-2">
                      <div class="col-8"><input id="ac-module-title" class="form-control form-control-sm fw-bold"
                          placeholder="Titulo del modulo" required></div>
                      <div class="col-4"><input type="number" id="ac-module-order" class="form-control form-control-sm"
                          placeholder="Orden" value="1"></div>
                    </div>
                    <input id="ac-module-desc" class="form-control form-control-sm mb-2"
                      placeholder="Descripcion breve (opcional)">
                    <div class="d-flex justify-content-between">
                      <button type="button" class="btn btn-light btn-sm text-danger d-none"
                        id="ac-btn-cancel-module">Cancelar</button>
                      <button type="button" class="btn btn-success btn-sm" id="ac-save-module"><i
                          class="bi bi-plus-lg me-1"></i>Guardar Modulo</button>
                    </div>
                  </form>
                  <hr>
                  <div id="ac-modules-list" class="list-group list-group-flush scroll-container"
                    style="max-height:300px;"></div>
                </div>
                <!-- TAB: Lecciones -->
                <div class="tab-pane fade" id="ac-tab-lec" role="tabpanel">
                  <div class="mb-3">
                    <label class="form-label small fw-bold">Modulo</label>
                    <select id="ac-module-select" class="form-select form-select-sm"></select>
                  </div>
                  <form id="ac-lesson-form">
                    <input type="hidden" id="ac-lesson-id">
                    <div class="row g-2 mb-2">
                      <div class="col-8"><input id="ac-lesson-title" class="form-control form-control-sm fw-bold"
                          placeholder="Titulo de la leccion" required></div>
                      <div class="col-4"><input type="number" id="ac-lesson-order" class="form-control form-control-sm"
                          placeholder="Orden" value="1"></div>
                    </div>
                    <textarea id="ac-lesson-text" class="form-control form-control-sm mb-2" rows="5"
                      placeholder="Contenido HTML o Texto..."></textarea>
                    <div id="ac-lesson-resources" class="mb-2">
                      <label class="form-label small fw-bold">Recursos multimedia</label>
                      <div id="ac-resources-list" class="vstack gap-2 mb-2"></div>
                      <button type="button" class="btn btn-sm btn-outline-secondary w-100" id="ac-add-resource">
                        <i class="bi bi-plus-circle me-1"></i>Agregar recurso
                      </button>
                    </div>
                    <div class="d-flex justify-content-between">
                      <button type="button" class="btn btn-light btn-sm text-danger d-none"
                        id="ac-btn-cancel-edit">Cancelar</button>
                      <button type="button" class="btn btn-success btn-sm" id="ac-save-lesson">Guardar Leccion</button>
                    </div>
                  </form>
                  <hr>
                  <div id="ac-lessons-list" class="list-group list-group-flush scroll-container"
                    style="max-height:250px;"></div>
                </div>
                <!-- TAB: Quiz -->
                <div class="tab-pane fade" id="ac-tab-quiz" role="tabpanel">
                  <form id="ac-quiz-form">
                    <input type="hidden" id="ac-quiz-id">
                    <div class="mb-3">
                      <label class="form-label small fw-bold">Titulo de la Evaluacion</label>
                      <input id="ac-quiz-title" class="form-control form-control-sm" placeholder="Ej: Examen Final"
                        required>
                    </div>
                    <div class="p-3 bg-light rounded-3 border mb-3">
                      <h6 class="small fw-bold text-muted text-uppercase mb-3"><i class="bi bi-sliders me-1"></i>Reglas
                      </h6>
                      <div class="row g-2">
                        <div class="col-4">
                          <label class="form-label small">Minimo (%)</label>
                          <input type="number" id="ac-quiz-min" class="form-control form-control-sm" value="70" min="1"
                            max="100">
                        </div>
                        <div class="col-4">
                          <label class="form-label small">Tiempo (min)</label>
                          <input type="number" id="ac-quiz-time" class="form-control form-control-sm" value="20"
                            min="0">
                          <div class="form-text" style="font-size:10px;">0 = Infinito</div>
                        </div>
                        <div class="col-4">
                          <label class="form-label small">Intentos</label>
                          <input type="number" id="ac-quiz-tries" class="form-control form-control-sm" value="3"
                            min="1">
                        </div>
                      </div>
                    </div>
                    <label class="form-label small fw-bold">Preguntas</label>
                    <div id="ac-quiz-items" class="vstack gap-2 mb-3"></div>
                    <button type="button" class="btn btn-sm btn-outline-primary mb-3 w-100" id="ac-quiz-add">
                      <i class="bi bi-plus-circle me-1"></i>Agregar Pregunta
                    </button>
                    <div class="d-flex justify-content-end gap-2 pt-2 border-top">
                      <button type="button" class="btn btn-light btn-sm d-none"
                        id="ac-btn-cancel-quiz">Cancelar</button>
                      <button type="button" class="btn btn-primary btn-sm" id="ac-save-quiz">Guardar Quiz</button>
                    </div>
                  </form>
                  <hr>
                  <div id="ac-quizzes-list" class="list-group"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="aulaQuizModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="aula-quiz-title">Evaluación</h5><button type="button" class="btn-close"
            data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="aula-quiz-body"></div>
        <div class="modal-footer"><button class="btn btn-primary w-100" id="aula-quiz-submit">Enviar
            Respuestas</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalAulaStudents" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Gestión de Estudiantes</h5><button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <h6 id="aula-students-course-title" class="text-muted mb-3"></h6>
          <div id="aula-students-loading" class="text-center">
            <div class="spinner-border text-primary"></div>
          </div>
          <div id="aula-students-empty" class="d-none text-center text-muted">Sin alumnos.</div>
          <div class="table-responsive">
            <table id="aula-students-table" class="table table-hover d-none">
              <tbody id="aula-students-list"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Aula Admin: Publicar aviso -->
  <div class="modal fade" id="modalAulaAdmAviso" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
      <div class="modal-content rounded-4">
        <div class="modal-header border-0">
          <h5 class="modal-title fw-bold">
            <i class="bi bi-megaphone-fill me-2 text-primary"></i>
            Publicar aviso de Aula
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <form id="aula-adm-aviso-modal-form">
          <div class="modal-body pt-0">
            <div class="mb-3">
              <label for="adm-aviso-text" class="form-label small fw-semibold">Mensaje</label>
              <textarea id="adm-aviso-text" class="form-control" rows="3"
                placeholder="Escribe el aviso que verán los estudiantes y docentes de Aula..." required=""></textarea>
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <label for="adm-aviso-tipo" class="form-label small fw-semibold">Tipo de aviso</label>
                <select id="adm-aviso-tipo" class="form-select form-select-sm">
                  <option value="urgente">Urgente</option>
                  <option value="aviso" selected="">Aviso</option>
                  <option value="recomendacion">Recomendación</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="adm-aviso-duracion" class="form-label small fw-semibold">Duración</label>
                <select id="adm-aviso-duracion" class="form-select form-select-sm">
                  <option value="0">Hasta nuevo aviso</option>
                  <option value="60">1 hora</option>
                  <option value="180">3 horas</option>
                  <option value="1440" selected="">1 día</option>
                  <option value="4320">3 días</option>
                  <option value="10080">1 semana</option>
                </select>
              </div>
            </div>

            <p class="small text-muted mt-3 mb-0">
              Los avisos urgentes aparecerán primero en el banner de Novedades. La duración controla hasta cuándo se
              mostrará el aviso.
            </p>
          </div>
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-send-fill me-1"></i> Publicar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Aula: listado completo de avisos -->
  <div class="modal fade" id="modalAulaAvisos" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content rounded-4">
        <div class="modal-header border-0">
          <h5 class="modal-title fw-bold">Novedades y avisos de Aula</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body pt-0">
          <p class="text-muted small mb-3">
            Aquí verás los avisos activos ordenados por prioridad y fecha. Los avisos urgentes aparecen primero.
          </p>
          <ul class="list-group list-group-flush" id="aula-avisos-modal-list"></ul>
          <div id="aula-avisos-modal-empty" class="text-center text-muted small py-4 d-none">
            <i class="bi bi-bell-slash mb-2 d-block fs-3"></i>
            No hay avisos activos por el momento.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" id="toast-container"
    style="z-index: 2000;"></div>



  <sia-dev-tools></sia-dev-tools>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- jsPDF ya está cargado en línea 42-43 con autoTable -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- SCRIPTS LOCALES CON CACHE-BUSTING AUTOMÁTICO -->
  <script>
    // [NEW ARCHITECTURE] Core & Components
    const localScripts = [
      '/config/departments.js',       // Config Global (Critical: Before App)
      '/services/firebase.js',        // Base SDK
      '/utils/pdf-generator.js',      // Utils
      '/services/notify.js',          // Global Service
      '/utils/ui.js',                 // Utils
      '/core/state.js',               // Core State
      '/core/ui.js',                  // Core UI
      '/core/router.js',              // Core Router
      '/core/auth.js',                // Core Auth
      '/components/navbar.js',        // Web Component
      '/components/landing-view.js',  // Web Component
      '/services/lactario-service.js', // [NEW]
      '/modules/lactario.js',         // [NEW]
      '/modules/register.js',         // Needed globally for now
      '/main.js',                     // New Entry Point
      '/app.js'                       // Legacy Glue (Runs last)
    ];

    localScripts.forEach(src => {
      // Force type="module" on new scripts to ensure execution order and scope
      const typeAttr = (src.includes('/core/') || src.includes('/components/') || src.includes('main.js') || src.includes('app.js')) ? ' type="module"' : '';
      document.write(`<script src="${src}?v=${window.SIA_VERSION}"${typeAttr}><\/script>`);
    });

    /* [LAZY LOADED MODULES] - managed by Router.js */
  </script>


  <!-- FAB: crear curso Aula -->
  <button type="button" id="aula-add-course-fab" class="btn btn-primary rounded-circle shadow position-fixed d-none"
    style="bottom: 1.5rem; right: 1.5rem; z-index: 1080;">
    <i class="bi bi-plus-lg"></i>
  </button>


  <!-- PWA INSTALL PROMPT -->
  <div class="pwa-install-sheet" id="pwa-install-sheet">
    <div class="d-flex align-items-center gap-3">
      <div class="pwa-icon">
        <i class="bi bi-rocket-takeoff-fill"></i>
      </div>
      <div>
        <h5 class="fw-bold mb-1">Instalar SIA Móvil</h5>
        <p class="text-muted small mb-0">Accede más rápido y sin conexión.</p>
      </div>
    </div>
    <div class="d-flex gap-2 mt-4">
      <button class="btn btn-light rounded-pill flex-fill fw-bold" id="pwa-dismiss">Ahora no</button>
      <button class="btn btn-primary rounded-pill flex-fill fw-bold" id="pwa-install">Instalar App</button>
    </div>
  </div>




  <!-- MODULES DRAWER OVERLAY (Dynamic) -->
  <div id="sia-modules-drawer" class="d-none modules-drawer-overlay">
    <div class="modules-drawer-content bg-surface shadow-lg rounded-top-4 p-4"
      style="max-height: 85vh; overflow-y: auto;">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="fw-bold mb-0">Módulos Disponibles</h5>
        <button class="btn-close" onclick="window.SIA.toggleModulesDrawer()" aria-label="Cerrar"></button>
      </div>

      <!-- Content will be populated dynamically by updateModulesDrawerContent() -->
      <div id="modules-drawer-body">
        <div class="text-center py-5 text-muted">
          <i class="bi bi-grid-fill fs-1 opacity-25 mb-2 d-block"></i>
          <span class="small">Cargando módulos...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- SPEED DIAL DRAWER (Quick Actions) -->
  <div id="sia-speed-dial-drawer" class="d-none modules-drawer-overlay">
    <div class="modules-drawer-content bg-surface shadow-lg rounded-top-4 p-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="fw-bold mb-0">Acciones Rápidas</h5>
        <button class="btn-close" onclick="window.SIA.toggleSpeedDial()"></button>
      </div>

      <div class="d-grid gap-3">
        <!-- Buscar en SIA -->
        <button class="speed-dial-action" onclick="window.SIA.toggleSpeedDial(); window.SIA.openMobileSearch();">
          <div class="speed-dial-icon bg-primary-subtle">
            <i class="bi bi-search text-primary fs-4"></i>
          </div>
          <div class="speed-dial-text">
            <div class="fw-bold small">Buscar en SIA</div>
            <div class="extra-small text-muted">Módulos, acciones y más</div>
          </div>
          <i class="bi bi-chevron-right text-muted"></i>
        </button>

        <!-- Agendar Cita Médica -->
        <button class="speed-dial-action" onclick="window.SIA.navigate('view-medi'); window.SIA.toggleSpeedDial();">
          <div class="speed-dial-icon bg-danger-subtle">
            <i class="bi bi-calendar-plus text-danger fs-4"></i>
          </div>
          <div class="speed-dial-text">
            <div class="fw-bold small">Agendar Cita Médica</div>
            <div class="extra-small text-muted">Consulta médica o psicológica</div>
          </div>
          <i class="bi bi-chevron-right text-muted"></i>
        </button>

        <!-- Reservar Libro -->
        <button class="speed-dial-action" onclick="window.SIA.navigate('view-biblio'); window.SIA.toggleSpeedDial();">
          <div class="speed-dial-icon bg-warning-subtle">
            <i class="bi bi-book text-warning fs-4"></i>
          </div>
          <div class="speed-dial-text">
            <div class="fw-bold small">Reservar Libro</div>
            <div class="extra-small text-muted">Catálogo de biblioteca</div>
          </div>
          <i class="bi bi-chevron-right text-muted"></i>
        </button>

        <!-- Mi Credencial Digital (Condicional: No Admin) -->
        <button class="speed-dial-action" id="speed-dial-qr" onclick="openDigitalID(); window.SIA.toggleSpeedDial();">
          <div class="speed-dial-icon bg-primary-subtle">
            <i class="bi bi-qr-code text-primary fs-4"></i>
          </div>
          <div class="speed-dial-text">
            <div class="fw-bold small">Mi Credencial Digital</div>
            <div class="extra-small text-muted">Código QR estudiantil</div>
          </div>
          <i class="bi bi-chevron-right text-muted"></i>
        </button>

        <!-- Nueva Queja/Sugerencia -->
        <button class="speed-dial-action" onclick="window.SIA.navigate('view-quejas'); window.SIA.toggleSpeedDial();">
          <div class="speed-dial-icon bg-info-subtle">
            <i class="bi bi-chat-heart text-info fs-4"></i>
          </div>
          <div class="speed-dial-text">
            <div class="fw-bold small">Quejas y Sugerencias</div>
            <div class="extra-small text-muted">Comparte tu opinión</div>
          </div>
          <i class="bi bi-chevron-right text-muted"></i>
        </button>

        <!-- Explorar Eventos -->
        <button class="speed-dial-action" onclick="window.SIA.navigate('view-foro'); window.SIA.toggleSpeedDial();">
          <div class="speed-dial-icon bg-success-subtle">
            <i class="bi bi-calendar-event text-success fs-4"></i>
          </div>
          <div class="speed-dial-text">
            <div class="fw-bold small">Eventos del Campus</div>
            <div class="extra-small text-muted">Próximos eventos y foros</div>
          </div>
          <i class="bi bi-chevron-right text-muted"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- MOBILE SEARCH DRAWER -->
  <div id="sia-mobile-search-drawer" class="d-none modules-drawer-overlay">
    <div class="modules-drawer-content bg-surface shadow-lg rounded-top-4 p-4" style="max-height: 90vh;">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold mb-0">Buscar</h5>
        <button class="btn-close" onclick="window.SIA.closeMobileSearch()" aria-label="Cerrar"></button>
      </div>

      <!-- Search Input -->
      <div class="search-wrapper position-relative mb-3">
        <i class="bi bi-search search-icon-sia"></i>
        <input type="text" id="mobile-search-input" class="search-input-sia" placeholder="Buscar módulos, acciones..."
          autocomplete="off" autofocus />
        <div id="mobile-search-results" class="search-results-dropdown d-none"></div>
      </div>

      <!-- Quick Access -->
      <div class="mt-4">
        <div class="extra-small text-muted text-uppercase mb-2 fw-bold">Acceso Rápido</div>
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-sm btn-outline-primary rounded-pill"
            onclick="document.getElementById('mobile-search-input').value='aula'; document.getElementById('mobile-search-input').dispatchEvent(new Event('input'));">
            Aula
          </button>
          <button class="btn btn-sm btn-outline-danger rounded-pill"
            onclick="document.getElementById('mobile-search-input').value='médico'; document.getElementById('mobile-search-input').dispatchEvent(new Event('input'));">
            Médico
          </button>
          <button class="btn btn-sm btn-outline-warning rounded-pill"
            onclick="document.getElementById('mobile-search-input').value='biblioteca'; document.getElementById('mobile-search-input').dispatchEvent(new Event('input'));">
            Biblioteca
          </button>
          <button class="btn btn-sm btn-outline-info rounded-pill"
            onclick="document.getElementById('mobile-search-input').value='eventos'; document.getElementById('mobile-search-input').dispatchEvent(new Event('input'));">
            Eventos
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- NOTIFICATIONS VIEW MODAL -->
  <!-- NOTIFICATIONS DRAWER (Redesign: Bottom Sheet) -->
  <div id="sia-notifications-drawer" class="d-none modules-drawer-overlay">
    <div class="modules-drawer-content bg-surface shadow-lg rounded-top-4 p-4"
      style="max-height: 80vh; overflow-y: auto;">
      <div class="d-flex justify-content-between align-items-center mb-0 sticky-top bg-white pb-3" style="z-index: 1;">
        <h5 class="fw-bold mb-0">Avisos y Novedades</h5>
        <button class="btn-close" onclick="window.SIA.toggleNotificationsView()"></button>
      </div>

      <!-- Dark Mode Switch matches Drawer style -->
      <div class="d-flex justify-content-between align-items-center p-3 mb-3 bg-light rounded-4">
        <div class="d-flex align-items-center gap-2">
          <div class="icon-box-sm bg-dark text-white rounded-circle"><i class="bi bi-moon-stars-fill"></i></div>
          <span class="small fw-bold">Modo Oscuro</span>
        </div>
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="switch-dark-mode-notifs" onchange="toggleDarkMode()">
        </div>
      </div>

      <!-- Notifications List -->
      <div class="list-group list-group-flush" id="notifs-list">
        <div class="text-center py-5 text-muted small">
          <i class="bi bi-bell-slash fs-1 opacity-25 mb-2 d-block"></i>
          No tienes notificaciones nuevas.
        </div>
      </div>
    </div>
  </div>


  <!-- Config (Must be before app.js) -->
  <script>
    document.write(`<script src="config/departments.js?v=${window.SIA_VERSION}"><\/script>`);
  </script>

  <!-- Modules -->
  <script>
    loadScript('services/quejas-service.js');
    loadScript('modules/quejas.js');
  </script>
</body>

</html>